# 🌐 局域网访问完整指南

让团队成员通过局域网访问 Knowledge AI 助手的完整教程。

---

## 📂 目录

1. [工具包说明](#工具包说明)
2. [快速开始 (3分钟)](#快速开始)
3. [详细配置步骤](#详细配置步骤)
4. [监控和管理](#监控和管理)
5. [故障排除](#故障排除)
6. [网络架构说明](#网络架构说明)
7. [安全建议](#安全建议)
8. [常见问题 FAQ](#常见问题-faq)

---

## 📦 工具包说明

### 🚀 启动脚本

| 文件 | 用途 | 运行方式 | 说明 |
|------|------|----------|------|
| `start-all-services.bat` | 🌟 **一键启动所有服务** | 双击运行 | 推荐使用 |
| `start-server.bat` | 启动 Web 服务器 (8081) | 双击运行 | 单独启动 |

### ⚙️ 配置与测试工具

| 文件 | 用途 | 运行方式 | 必需性 |
|------|------|----------|--------|
| `setup-firewall.bat` | 配置防火墙规则 | **右键 → 管理员运行** | ✅ 必需 |
| `test-lan-connection.bat` | 测试连接和诊断问题 | 双击运行 | 🔍 排查用 |
| `monitor-connections.ps1` | 实时监控连接 | PowerShell 运行 | 📊 监控用 |
| `manage-users.ps1` | 管理用户映射 (IP→姓名) | PowerShell 运行 | 👥 管理用 |

### 📖 文档

- **本文件** (`LAN-SETUP-GUIDE.md`) - 完整教程,包含所有信息

---

## 🚀 快速开始

### 👨‍💼 管理员操作 (首次配置)

#### 第 1 步: 配置防火墙 ⚠️ 必须!

**右键点击** `setup-firewall.bat` → **以管理员身份运行**

等待看到:
```
✅ 完成
配置完成!
```

#### 第 2 步: 启动所有服务

**双击** `start-all-services.bat`

会自动:
1. 检查防火墙配置
2. 启动 API Server (等待 15 秒)
3. 启动 Web Server
4. 显示局域网访问地址

示例输出:
```
局域网访问地址:
  Web 界面: http://192.168.1.100:8081
  API 服务: http://192.168.1.100:8080
```

#### 第 3 步: 分享地址给同事

将 **Web 界面地址** 发给同事:
```
http://192.168.1.100:8081
```

✅ 完成! 管理员配置结束。

---

### 👥 同事操作 (第一次使用)

#### 第 1 步: 打开网页

在浏览器输入管理员提供的地址:
```
http://192.168.1.100:8081
```

#### 第 2 步: 配置 API

点击右上角 **⚙️ 设置**,填写:

1. **API URL**: `http://192.168.1.100:8080` 
   
   ⚠️ **重要**: 
   - 端口是 **8080** 或 **23333** (向管理员确认)
   - 不是 8081!

2. **API Key**: 向管理员索取

3. **模型**: 从下拉列表选择一个可用模型

4. 点击 **保存配置** ✅

#### 第 3 步: 导入助手配置 (可选)

如果管理员提供了知识库配置文件 (`.json`):

1. 在设置页面点击 **导入助手配置**
2. 选择 `.json` 文件上传
3. 成功! 现在可以使用知识库

#### 第 4 步: 开始聊天

- 在输入框输入问题
- 按回车发送
- 看到 AI 逐字回复 ✨

✅ 完成! 可以正常使用了。

#### 后续使用

配置会保存在浏览器中,后续只需:
1. 打开地址
2. 直接聊天

---

## 📋 详细配置步骤

### 管理员完整流程

#### 1. 准备工作

**检查环境:**
- ✅ Python 已安装 (运行 Web Server 需要)
- ✅ Node.js 已安装 (运行 API Server 需要)
- ✅ 项目依赖已安装 (`npm install` / `yarn install`)

**获取本机 IP:**

方法 1 - 命令行:
```cmd
ipconfig
```
查找 **IPv4 地址**,通常格式:
- `192.168.x.x` (家庭/公司网络)
- `10.x.x.x` (企业网络)

⚠️ 不是 `127.0.0.1` (本机回环地址)

方法 2 - 自动显示:
运行 `start-all-services.bat` 会自动显示

#### 2. 配置防火墙

**为什么需要?**
Windows 防火墙默认阻止外部连接,必须添加规则允许端口 8081 和 8080。

**操作步骤:**

1. 找到 `setup-firewall.bat`
2. **右键** → **以管理员身份运行**
3. 等待脚本执行完成

**成功标志:**
```
[2/4] 添加规则: Web Client (端口 8081)...
✅ 完成

[3/4] 添加规则: API Server (端口 8080)...
✅ 完成

配置完成!
```

**验证规则:**
```cmd
netsh advfirewall firewall show rule name="Knowledge Web Client (8081)"
```

应该显示规则详情,不是 "找不到规则"。

#### 3. 启动服务

**方式一: 一键启动 (推荐)**

双击 `start-all-services.bat`

会打开两个新窗口:
1. **Knowledge API Server** - 运行后端服务
2. **Knowledge Web Client** - 运行前端服务

⚠️ **不要关闭这两个窗口!** 可以最小化。

**方式二: 分别启动**

如果需要单独控制:

1. 启动 API Server:
   ```cmd
   cd E:\Project\RAG_knowledge
   启动Cherry Studio.bat
   ```

2. 启动 Web Server:
   ```cmd
   cd E:\Project\RAG_knowledge\web-client
   start-server.bat
   ```

**启动成功标志:**

API Server 输出:
```
API Server started at http://0.0.0.0:8080
或
API Server started at http://0.0.0.0:23333
```

Web Server 输出:
```
局域网访问: http://192.168.1.100:8081
```

#### 4. 记录 API Key

在 API Server 启动日志中找到:
```
API Key: cs-sk-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
```

复制保存,需要分享给同事。

#### 5. 导出助手配置 (可选)

如果想让同事使用知识库:

1. 在桌面端 Cherry Studio 中:
   - 打开助手设置
   - 配置好知识库和模型
   - 点击 "导出配置"
   - 保存为 `.json` 文件

2. 将 `.json` 文件分享给同事

#### 6. 分享信息给同事

准备以下信息:

```
📱 Web 访问地址:
http://192.168.1.100:8081

🔌 API 服务地址:
http://192.168.1.100:8080 (或 23333,查看启动日志)

🔑 API Key:
cs-sk-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx

📚 助手配置文件:
assistant-config.json (如果有)
```

通过内部聊天工具/邮件发送。

---

### 同事详细配置流程

#### 1. 网络连接测试

**确认在同一局域网:**

打开命令提示符 (Win + R → `cmd`):
```cmd
ping 192.168.1.100
```

如果看到:
```
来自 192.168.1.100 的回复: 字节=32 时间<1ms TTL=128
```
说明网络连通 ✅

如果显示 "请求超时":
- ❌ 不在同一网络
- 或防火墙配置有问题

#### 2. 访问 Web 界面

在浏览器地址栏输入:
```
http://192.168.1.100:8081
```

**应该看到:**
- 聊天界面
- 输入框
- 右上角设置按钮 ⚙️

**如果无法访问:**
- 检查地址是否正确 (端口是 8081)
- 确认管理员的服务已启动
- 联系管理员运行 `test-lan-connection.bat` 诊断

#### 3. 首次配置

点击右上角 **⚙️ 设置**:

**必填项:**

1. **API URL**
   ```
   http://192.168.1.100:8080
   ```
   或
   ```
   http://192.168.1.100:23333
   ```
   
   ⚠️ 向管理员确认实际端口!

2. **API Key**
   
   粘贴管理员提供的 Key:
   ```
   cs-sk-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
   ```

3. **模型**
   
   点击下拉框,选择一个可用模型,例如:
   - `gpt-3.5-turbo`
   - `gpt-4`
   - 或管理员指定的模型

**保存配置:**

点击 **保存配置** 按钮,应该看到:
```
✅ 配置已保存
```

#### 4. 导入知识库配置 (可选)

如果管理员提供了 `.json` 配置文件:

1. 在设置页面找到 **导入助手配置**
2. 点击 **选择文件**
3. 选择 `assistant-config.json`
4. 点击 **上传**

成功后配置会自动加载。

#### 5. 测试聊天

**基础测试:**

输入简单问题:
```
你好,请介绍一下你自己
```

按回车,应该看到:
- 回答逐字显示 (流式输出)
- 1-2 秒内开始显示

**知识库测试 (如果有):**

输入知识库相关问题:
```
[根据你们公司的知识库内容提问]
```

应该看到:
- 首先显示 "🔍 正在搜索知识库..."
- 然后显示基于知识库的准确答案

✅ 配置完成!

---

## � 监控和管理

### 多人同时使用

✅ **可以同时多人使用,没有硬性数量限制**

**取决于:**
- 你的电脑性能 (CPU、内存)
- 并发请求量
- 知识库搜索复杂度

**建议人数:**

| 配置 | 推荐人数 |
|------|----------|
| 低配 (4核/16GB) | 3-5 人 |
| 中配 (8核/32GB) | 10-15 人 |
| 高配 (16核/64GB) | 30+ 人 |

### 方法 1: 实时监控连接 (推荐)

**运行监控脚本:**
```powershell
cd E:\Project\RAG_knowledge\web-client
.\monitor-connections.ps1
```

**显示效果:**
```
========================================
  Knowledge AI - Connection Monitor
========================================

Server IP: 10.216.186.24
Refresh every 5 seconds (Press Ctrl+C to exit)

[14:30:15] Active Connections:
----------------------------------------
  IP: 10.216.186.25
    Web (8081): 1 connection(s)
    API (8080): 2 connection(s)

  IP: 10.216.186.26
    Web (8081): 1 connection(s)

Total: 4 active connection(s)
----------------------------------------
```

**说明:**
- 每 5 秒自动刷新
- 显示每个 IP 的连接数
- 区分 Web 界面连接和 API 调用连接
- 按 Ctrl+C 退出

### 方法 2: 管理用户映射

如果想知道 IP 对应哪个同事,使用用户管理工具:

**运行:**
```powershell
.\manage-users.ps1
```

**功能菜单:**
```
1. Add new mapping     - 添加 IP → 用户名映射
2. Remove mapping      - 删除映射
3. Show connections    - 显示当前连接 (含用户名)
4. Exit               - 退出
```

**使用示例:**

1. 选择 `1` 添加映射:
   ```
   Enter IP address: 10.216.186.25
   Enter user name: 张三
   → Mapping added: 10.216.186.25 -> 张三
   ```

2. 选择 `3` 查看连接:
   ```
   Active connections:
   
     IP: 10.216.186.25
     User: 张三
       Web connections: 1
       API connections: 2
   
     IP: 10.216.186.26
     User: Unknown
       Web connections: 1
   ```

### 方法 3: 查看 API Server 日志

在运行 `启动Cherry Studio.bat` 的终端窗口,可以实时看到请求日志:

```
POST /v1/chat/completions 200 2.5s
来自: 10.216.186.25

POST /v1/chat/completions 200 3.1s
来自: 10.216.186.26
```

### 如何知道同事的 IP?

**方法 1: 询问同事**
让同事在电脑上运行:
```cmd
ipconfig
```
查看 IPv4 地址

**方法 2: 监控观察**
当同事首次连接时,监控窗口会显示新 IP,询问 "谁刚连接的?"

**方法 3: 查看测试日志**
同事运行 `test-lan-connection.bat` 会显示他的 IP

### 注意事项

1. **IP 可能变化**: 如果使用 DHCP,IP 地址可能会变,需定期更新映射

2. **连接数说明**:
   - Web (8081): 浏览器保持的连接 (1个)
   - API (8080): 发送消息时的 API 调用 (可能多个)
   - 同一人有多个连接是正常现象

3. **性能监控**: 如果连接数过多 (>20),注意电脑性能,可通过任务管理器查看

---

## �🔍 故障排除

### 🛠️ 使用诊断工具

**当遇到任何问题时,首先运行诊断工具:**

双击 `test-lan-connection.bat`

会自动检测:
- ✅ 服务是否运行
- ✅ 防火墙是否配置
- ✅ 局域网是否可访问
- 📋 给出具体建议

**示例输出:**
```
[1/4] Testing local connection...
  [OK] Web Server: Running
  [FAIL] API Server: Not running

[2/4] Testing LAN connection...
  [OK] LAN accessible

[3/4] Testing firewall rules...
  [OK] Web Client (8081): Configured
  [OK] API Server (8080): Configured

Recommended Actions:
  [!] Need to start API Server
     -> Run start Cherry Studio.bat
```

根据建议操作即可。

---

### ❌ 常见错误及解决方案

#### 错误 1: 无法打开网页

**症状:**
- 浏览器显示 "无法访问此网站"
- 或 "ERR_CONNECTION_REFUSED"

**排查步骤:**

1. **检查 Web Server 是否运行:**
   
   在管理员电脑,浏览器打开:
   ```
   http://localhost:8081
   ```
   
   - ✅ 能打开 → Web Server 正常,是防火墙/网络问题
   - ❌ 不能打开 → Web Server 未启动

   **解决**: 运行 `start-server.bat`

2. **检查防火墙规则:**
   
   在管理员电脑运行:
   ```cmd
   netsh advfirewall firewall show rule name="Knowledge Web Client (8081)"
   ```
   
   - ✅ 显示规则详情 → 防火墙已配置
   - ❌ "找不到规则" → 防火墙未配置

   **解决**: 以管理员身份运行 `setup-firewall.bat`

3. **检查 IP 地址是否正确:**
   
   在管理员电脑运行:
   ```cmd
   ipconfig
   ```
   
   确认 IPv4 地址,更新分享给同事的地址。

4. **检查是否在同一网络:**
   
   在同事电脑运行:
   ```cmd
   ping 192.168.1.100
   ```
   
   - ✅ 有回复 → 网络通畅
   - ❌ 请求超时 → 不在同一网络或被防火墙阻止

---

#### 错误 2: 网页能打开,但无法聊天

**症状:**
- Web 界面正常显示
- 发送消息后无响应
- 或显示错误 "API 错误 XXX"

**排查步骤:**

1. **检查 API URL 配置:**
   
   在 Web 界面,点击 ⚙️ 设置,检查:
   
   - API URL 端口是否正确 (8080 或 23333)
   - 格式: `http://192.168.1.100:8080` (注意 http 不是 https)

2. **检查 API Server 是否运行:**
   
   在浏览器打开:
   ```
   http://192.168.1.100:8080/v1/models
   ```
   
   - ✅ 显示 JSON 数据 → API Server 正常
   - ❌ 无法访问 → API Server 未启动或端口错误

   **解决**: 运行 `启动Cherry Studio.bat`

3. **检查 API Key:**
   
   - API Key 是否完整复制 (包含 `cs-sk-` 前缀)
   - 是否和管理员提供的一致

4. **检查模型配置:**
   
   - 是否选择了模型
   - 模型名称是否正确

5. **查看浏览器控制台:**
   
   按 `F12` 打开开发者工具,切换到 Console 标签,查看错误信息:
   
   - `401 Unauthorized` → API Key 错误
   - `404 Not Found` → API URL 或端口错误
   - `Network Error` → 网络连接问题

---

#### 错误 3: 回复很慢或超时

**症状:**
- 发送消息后长时间无响应
- 或显示 "⏳ 正在思考..." 很久

**可能原因及解决方案:**

1. **正常情况 - 知识库搜索:**
   
   如果使用了知识库:
   - 首个回复需要 1-2 秒 (搜索知识库)
   - 然后开始流式输出
   
   这是正常的,耐心等待。

2. **模型响应慢:**
   
   大模型 (如 GPT-4) 响应较慢,可以:
   - 换用更快的模型 (如 GPT-3.5-turbo)
   - 或接受较长等待时间

3. **服务器性能不足:**
   
   检查管理员电脑:
   - CPU 使用率是否过高
   - 内存是否充足
   
   可以:
   - 关闭其他程序释放资源
   - 减少知识库数量
   - 升级硬件

4. **网络延迟:**
   
   在同事电脑测试网络:
   ```cmd
   ping 192.168.1.100 -t
   ```
   
   查看延迟时间:
   - < 10ms: 优秀
   - 10-50ms: 良好
   - > 100ms: 较差,检查网络

---

#### 错误 4: 防火墙配置失败

**症状:**
- 运行 `setup-firewall.bat` 后显示 "需要管理员权限"
- 或规则添加失败

**解决方案:**

1. **确保以管理员身份运行:**
   
   - **右键点击** `setup-firewall.bat`
   - 选择 **"以管理员身份运行"**
   - 不是直接双击!

2. **手动添加规则:**
   
   如果脚本失败,手动配置:
   
   a. 打开 "Windows Defender 防火墙"
   
   b. 点击 "高级设置"
   
   c. 选择 "入站规则"
   
   d. 点击右侧 "新建规则"
   
   e. 选择 "端口" → 下一步
   
   f. 选择 "TCP",输入端口 `8081,8080` → 下一步
   
   g. 选择 "允许连接" → 下一步
   
   h. 全选 (域、专用、公用) → 下一步
   
   i. 名称填写 `Knowledge LAN Access` → 完成

3. **临时关闭防火墙测试 (不推荐):**
   
   仅用于确认是防火墙问题:
   
   ```cmd
   # 临时关闭 (需管理员权限)
   netsh advfirewall set allprofiles state off
   
   # 测试访问...
   
   # 测试后立即重新开启!
   netsh advfirewall set allprofiles state on
   ```

---

#### 错误 5: 流式响应不工作

**症状:**
- 消息发送后长时间空白
- 然后突然显示完整答案 (不是逐字显示)

**排查步骤:**

1. **检查浏览器控制台 (F12):**
   
   查看是否有 JavaScript 错误。

2. **检查 API Server 版本:**
   
   确认 API Server 支持流式响应。

3. **清除浏览器缓存:**
   
   按 `Ctrl + Shift + Delete`,清除缓存后刷新页面。

4. **尝试其他浏览器:**
   
   在 Chrome / Edge / Firefox 中测试。

---

### 🔍 高级诊断

#### 查看 API Server 日志

在运行 `启动Cherry Studio.bat` 的窗口,查看实时日志:

```
[INFO] API Server started at http://0.0.0.0:8080
[INFO] API Key: cs-sk-xxx...
POST /v1/chat/completions 200 2.5s
```

关键信息:
- 启动地址和端口
- API Key
- 每个请求的状态码和响应时间

#### 查看浏览器网络请求

在 Web 界面:
1. 按 `F12` 打开开发者工具
2. 切换到 **Network** 标签
3. 发送一条消息
4. 查看网络请求:

**正常情况:**
```
POST http://192.168.1.100:8080/v1/chat/completions
Status: 200 OK
Type: fetch
```

**异常情况:**
- `Status: 401` → API Key 错误
- `Status: 404` → URL 或端口错误
- `Status: (failed)` → 网络连接问题
- `Status: 500` → 服务器内部错误

#### 测试 API 端点

使用 `curl` 测试 API 是否正常:

```cmd
curl -X POST http://192.168.1.100:8080/v1/chat/completions ^
  -H "Content-Type: application/json" ^
  -H "Authorization: Bearer cs-sk-xxx..." ^
  -d "{\"model\":\"gpt-3.5-turbo\",\"messages\":[{\"role\":\"user\",\"content\":\"hello\"}],\"stream\":false}"
```

应该返回 JSON 格式的回复。

---

## 🏗️ 网络架构说明

### 系统架构图

```
┌─────────────────────────────────────────────┐
│  同事的电脑 (192.168.1.101)                 │
│                                             │
│  ┌──────────────────────────────────────┐  │
│  │  浏览器                               │  │
│  │  http://192.168.1.100:8081           │  │
│  └──────────────┬───────────────────────┘  │
└─────────────────┼───────────────────────────┘
                  │
                  │ 局域网
                  │ (192.168.1.x)
                  │
┌─────────────────▼───────────────────────────┐
│  管理员的电脑 (192.168.1.100)               │
│                                             │
│  ┌─────────────────┐  ┌──────────────────┐ │
│  │ Web Server      │  │  API Server      │ │
│  │ Python HTTP     │  │  Express.js      │ │
│  │ 端口: 8081      │  │  端口: 8080      │ │
│  │ (静态文件)      │  │  (API 服务)      │ │
│  └─────────────────┘  └────────┬─────────┘ │
│                                 │           │
│  ┌──────────────────────────────▼─────────┐ │
│  │  知识库 (embedjs + LibSqlDb)          │ │
│  │  - 文档向量化                          │ │
│  │  - 语义搜索                            │ │
│  │  - Rerank 排序                         │ │
│  └────────────────────────────────────────┘ │
│                                             │
│  ┌─────────────────────────────────────────┐│
│  │  AI 模型 (通过 Provider API)           ││
│  │  - OpenAI / Claude / 本地模型等        ││
│  └─────────────────────────────────────────┘│
└─────────────────────────────────────────────┘
```

### 数据流程

#### 普通对话流程

1. 用户在浏览器输入问题
2. 浏览器发送 POST 请求到 `http://192.168.1.100:8080/v1/chat/completions`
3. API Server 接收请求
4. API Server 调用 AI 模型 API
5. 模型返回流式响应
6. API Server 转发流式数据
7. 浏览器实时显示逐字输出

**时间线:**
- T+0ms: 用户发送问题
- T+50ms: 请求到达 API Server
- T+500ms: 模型开始响应 (首个 token)
- T+500ms-20s: 持续流式输出
- T+20s: 完成回答

#### 知识库查询流程

1. 用户输入问题
2. API Server 检测到知识库配置
3. **搜索阶段** (~0.9s):
   - 将问题向量化 (Embedding)
   - 在向量数据库中搜索相似文档
   - 返回 Top 30 相关片段
4. **Rerank 阶段** (~0.1s):
   - 使用 Reranker 模型精排
   - 选出最相关的 Top 6 片段
5. **生成阶段**:
   - 将知识库内容注入到 Prompt
   - 调用 AI 模型生成回答
   - 流式返回结果

**时间线:**
- T+0ms: 用户发送问题
- T+50ms: 开始搜索知识库
- T+900ms: 搜索完成,开始 Rerank
- T+1000ms: Rerank 完成,调用模型
- T+1500ms: 首个 token 出现
- T+1500ms-25s: 流式输出
- T+25s: 完成回答

### 端口说明

| 端口 | 服务 | 协议 | 用途 | 访问者 |
|------|------|------|------|--------|
| 8081 | Web Server | HTTP | 提供静态页面 (HTML/JS/CSS) | 所有人 |
| 8080 | API Server | HTTP | 处理聊天请求,调用 AI | 仅 Web 界面 |
| 23333 | API Server (默认) | HTTP | 同上,取决于配置 | 仅 Web 界面 |

**注意:**
- API Server 实际端口可能是 8080 或 23333
- 查看启动日志确认: `API Server started at http://0.0.0.0:xxxxx`
- 防火墙需要开放实际使用的端口

### 网络要求

#### 同一局域网

所有设备必须在同一网络:

**判断方法:**
- IP 地址在同一网段
- 例如: 192.168.1.100 和 192.168.1.101 (前三段相同)
- 能够互相 ping 通

**常见网络:**
- 家庭 WiFi: 通常是 `192.168.0.x` 或 `192.168.1.x`
- 公司有线网: 可能是 `10.x.x.x` 或 `172.16.x.x`

#### 跨网段访问

如果需要跨不同网段 (例如 WiFi 和有线网):

1. **简单方案**: 让所有人连接同一网络
2. **路由方案**: 配置路由器路由表 (需网管权限)
3. **VPN 方案**: 使用 VPN 创建虚拟局域网
4. **云部署**: 部署到云服务器,通过公网访问

---

## 🔐 安全建议

### ✅ 安全最佳实践

#### 1. 仅在内部网络使用

- ✅ 公司内网
- ✅ 家庭网络
- ❌ 公共 WiFi (咖啡厅、机场等)
- ❌ 直接暴露到互联网

#### 2. 使用强 API Key

生成的 API Key 格式:
```
cs-sk-xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
```

- ✅ 系统自动生成 (UUID 格式,安全)
- ✅ 定期更换 (建议每月)
- ❌ 不要使用简单密码

**更换 API Key:**
1. 删除旧的 Key (在桌面端设置中)
2. 重启 API Server
3. 系统自动生成新 Key
4. 更新同事的配置

#### 3. 限制访问人员

- ✅ 仅分享给内部团队成员
- ❌ 不要公开分享地址和 Key
- 📋 记录谁在使用 (便于管理)

#### 4. 保护敏感数据

- ✅ 不要在知识库中存储密码、密钥等敏感信息
- ✅ 定期审查知识库内容
- ✅ 使用访问控制 (如果支持)

#### 5. 监控访问日志

定期查看 API Server 日志:
```
POST /v1/chat/completions 200 2.5s
来自: 192.168.1.105
```

发现异常访问立即更换 API Key。

#### 6. 物理安全

- ✅ 管理员电脑设置屏幕锁定
- ✅ 离开时锁定电脑 (Win + L)
- ❌ 不要在无人监管时保持服务运行

---

### ⚠️ 不推荐的做法

#### ❌ 直接暴露到公网

**错误示例:**
- 在路由器配置端口转发: 8080 → 管理员 IP
- 使用内网穿透服务 (如 ngrok, frp)
- 配置 DMZ 主机

**为什么不安全:**
- 无 HTTPS 加密,数据明文传输
- 无身份认证,任何人可访问
- 无请求限制,易被攻击
- 可能违反 AI 服务商条款

**如果必须远程访问:**

需要额外配置:
1. **HTTPS**: 配置 SSL 证书 (Let's Encrypt)
2. **认证**: 添加用户名/密码登录
3. **反向代理**: 使用 Nginx/Caddy
4. **限流**: 防止滥用 (Rate Limiting)
5. **VPN**: 或使用 VPN 访问内网

这超出本教程范围,请咨询专业人员。

#### ❌ 使用弱密码

**错误示例:**
- 将 API Key 改为 `123456`
- 使用 `password` 等简单密码

**正确做法:**
- 使用系统自动生成的 UUID 格式 Key
- 不要尝试自定义 Key

#### ❌ 在公共场所使用

**不要在以下场所使用:**
- 咖啡厅公共 WiFi
- 机场 / 酒店 WiFi
- 未加密的开放网络

**原因:**
- HTTP 流量未加密
- 他人可能监听网络流量
- 获取 API Key 和聊天内容

---

### 🛡️ 应急响应

#### API Key 泄露

如果怀疑 API Key 泄露:

1. **立即停止服务:**
   - 关闭 API Server 窗口
   - 或按 `Ctrl + C` 停止

2. **更换 API Key:**
   - 在桌面端删除旧 Key
   - 重启 API Server 生成新 Key

3. **通知所有用户:**
   - 告知同事更新配置
   - 提供新的 API Key

4. **检查日志:**
   - 查看是否有异常访问
   - 确认泄露范围

#### 发现未授权访问

在日志中看到不认识的 IP:

```
POST /v1/chat/completions 200 2.5s
来自: 192.168.1.250  ← 未授权 IP
```

**处理步骤:**

1. 记录 IP 地址
2. 更换 API Key (参考上一条)
3. 检查网络安全:
   - 是否有人蹭网
   - 路由器密码是否泄露
4. 加强防护:
   - 更换 WiFi 密码
   - 启用 MAC 地址过滤

---

## ❓ 常见问题 FAQ

### 通用问题

#### Q1: 需要什么硬件配置?

**管理员电脑 (服务器):**
- **CPU**: 4 核或以上 (推荐 8 核)
- **内存**: 16GB 或以上 (推荐 32GB)
- **硬盘**: 取决于知识库大小,建议 100GB 可用空间
- **网络**: 稳定的以太网或 WiFi 连接

**同事电脑 (客户端):**
- 任何能运行现代浏览器的设备
- 手机、平板也可以

#### Q2: 支持哪些浏览器?

**推荐浏览器:**
- ✅ Google Chrome (最佳)
- ✅ Microsoft Edge
- ✅ Firefox
- ✅ Safari (Mac/iOS)

**不支持:**
- ❌ IE 11 或更早版本

#### Q3: 能支持多少人同时使用?

取决于管理员电脑性能:

- **低配 (4核/16GB)**: 3-5 人
- **中配 (8核/32GB)**: 10-15 人
- **高配 (16核/64GB)**: 30+ 人

**性能瓶颈:**
- AI 模型响应速度
- 知识库搜索速度
- 网络带宽

#### Q4: 可以在手机上使用吗?

✅ 可以! 

只需在手机浏览器输入:
```
http://192.168.1.100:8081
```

**注意:**
- 确保手机连接同一 WiFi
- 使用现代浏览器 (Chrome / Safari)
- 界面会自适应移动端

#### Q5: 配置会保存吗?

✅ 会自动保存在浏览器本地存储 (localStorage)

**保存的内容:**
- API URL
- API Key
- 选择的模型
- 助手配置

**注意:**
- 清除浏览器缓存会删除配置
- 换用其他浏览器需要重新配置
- 换用其他设备需要重新配置

---

### 网络问题

#### Q6: 能从家里访问公司的服务吗?

❌ 默认不能,因为不在同一局域网。

**解决方案:**

1. **VPN**: 公司提供 VPN,连接后可访问
2. **远程桌面**: 使用 TeamViewer / 向日葵等远程连接到办公电脑
3. **云部署**: 将服务部署到云服务器 (需额外配置安全措施)

#### Q7: 两台电脑 ping 不通怎么办?

**可能原因:**

1. **不在同一网络:**
   - 一个连 WiFi,一个连有线
   - 路由器隔离了网段

   **解决**: 连接同一网络

2. **Windows 防火墙阻止 ping:**
   - 防火墙默认可能阻止 ICMP

   **解决**: 
   ```cmd
   # 允许 ping (以管理员运行)
   netsh advfirewall firewall add rule name="ICMP Allow" protocol=icmpv4:8,any dir=in action=allow
   ```

3. **网络隔离策略:**
   - 公司网络可能有隔离
   
   **解决**: 联系 IT 部门

#### Q8: 能通过无线热点共享吗?

✅ 可以!

**方法 1: Windows 移动热点**

管理员电脑:
1. 设置 → 网络和 Internet → 移动热点
2. 开启移动热点
3. 记下热点名称和密码

同事:
1. 连接该热点
2. 访问 `http://192.168.137.1:8081` (移动热点默认 IP)

**方法 2: 共享以太网**

管理员电脑连接有线网络,开启 WiFi 热点共享。

---

### 功能问题

#### Q9: 为什么有时回复很快,有时很慢?

**影响因素:**

1. **首次查询 vs 后续查询**
   - 首次: 需要初始化知识库 (~15s)
   - 后续: 缓存热启动 (~2s)

2. **是否使用知识库**
   - 不使用: 直接调用模型 (~0.5s 首 token)
   - 使用: 搜索 + Rerank + 模型 (~1.5s 首 token)

3. **模型选择**
   - 小模型 (GPT-3.5): 快 (~20s 完整回答)
   - 大模型 (GPT-4): 慢 (~60s 完整回答)

4. **问题复杂度**
   - 简单问题: 回答短,完成快
   - 复杂问题: 回答长,需要更多时间

#### Q10: 流式响应是什么意思?

**流式响应** = 答案逐字显示,实时输出

**对比:**

传统方式 (非流式):
```
[用户] 介绍一下 AI
[等待 30 秒...] 
[AI] [突然显示完整答案]
```

流式方式:
```
[用户] 介绍一下 AI
[1秒后] AI 是人工...
[2秒后] AI 是人工智能的...
[3秒后] AI 是人工智能的缩写...
[逐字显示,30秒完成]
```

**优势:**
- ✅ 更好的用户体验
- ✅ 感觉响应更快
- ✅ 可以提前看到部分答案

#### Q11: 知识库是必需的吗?

❌ 不是必需的

**不使用知识库:**
- 直接使用通用 AI 模型
- 回答基于模型训练数据
- 可能不准确或过时

**使用知识库:**
- 基于你们的内部文档
- 答案准确、专业、最新
- 适合企业内部使用

**配置方式:**
- 在桌面端配置知识库
- 导出配置
- 同事导入配置即可使用

#### Q12: 可以同时配置多个知识库吗?

✅ 可以!

在桌面端助手配置中:
1. 添加多个知识库
2. 导出配置
3. 同事导入后会自动搜索所有知识库

**搜索逻辑:**
- 并行搜索所有知识库
- 每个库返回 Top 结果
- 综合 Rerank 选出最相关内容

---

### 管理问题

#### Q13: 如何更新知识库内容?

在管理员的桌面端:
1. 打开知识库管理
2. 添加/删除/编辑文档
3. 重新索引
4. 无需重启服务,实时生效

同事无需任何操作,自动使用最新内容。

#### Q14: 如何添加新同事?

只需分享:
1. Web 访问地址
2. API URL
3. API Key
4. (可选) 助手配置文件

新同事按照 [同事操作](#同事操作-第一次使用) 章节配置即可。

#### Q15: 如何临时关闭服务?

**停止服务:**

在运行服务的窗口:
- 按 `Ctrl + C`
- 或直接关闭窗口

**重新启动:**

双击 `start-all-services.bat`

#### Q16: 服务能开机自启动吗?

需要手动配置:

**方法 1: 计划任务**

1. 打开 "任务计划程序"
2. 创建基本任务
3. 触发器: 用户登录时
4. 操作: 启动程序
5. 程序: `start-all-services.bat` 的完整路径

**方法 2: 启动文件夹**

1. 按 `Win + R` 输入 `shell:startup`
2. 创建快捷方式指向 `start-all-services.bat`
3. 重启测试

**注意:**
- 需要管理员保持登录
- 不关机或休眠

#### Q17: 如何查看有谁在使用?

查看 API Server 日志:

```
POST /v1/chat/completions 200 2.5s
来自: 192.168.1.101

POST /v1/chat/completions 200 3.1s
来自: 192.168.1.105
```

记下 IP 地址,对应不同同事。

**更详细的监控:**

可以自定义日志格式,记录:
- 时间戳
- 来源 IP
- 使用的模型
- 响应时间
- 消耗的 token

---

### 技术问题

#### Q18: 可以使用 HTTPS 吗?

默认使用 HTTP,配置 HTTPS 需要:

1. 申请 SSL 证书
2. 配置反向代理 (Nginx/Caddy)
3. 修改服务启动方式

**是否需要 HTTPS?**

- 局域网内使用: **不需要** (HTTP 足够安全)
- 公网访问: **必需** (保护数据安全)

#### Q19: API Server 端口能改吗?

✅ 可以,在桌面端设置中修改:

1. 打开 Cherry Studio
2. 设置 → API Server
3. 修改端口号
4. 重启 API Server

**注意:**
- 修改后需要更新防火墙规则
- 通知所有同事更新 API URL

#### Q20: 支持 Docker 部署吗?

当前教程基于 Windows + Python + Node.js。

**Docker 化**需要:
1. 编写 Dockerfile
2. 配置 docker-compose
3. 处理网络和卷映射

这超出本教程范围,可以参考项目文档或联系开发者。

---

## 🎓 总结

### 核心步骤回顾

**管理员 (首次):**
1. ✅ 以管理员身份运行 `setup-firewall.bat`
2. ✅ 双击 `start-all-services.bat`
3. ✅ 分享地址和 API Key 给同事

**同事 (首次):**
1. ✅ 打开分享的地址
2. ✅ 配置 API URL、Key 和模型
3. ✅ (可选) 导入助手配置
4. ✅ 开始聊天

**日常使用:**
- 管理员: 开机后运行 `start-all-services.bat`
- 同事: 直接打开地址使用

### 关键要点

1. **防火墙配置是必需的** (首次必做)
2. **API URL 端口可能是 8080 或 23333** (查看日志)
3. **流式响应提供更好体验** (逐字显示)
4. **知识库需要 1-2 秒搜索时间** (正常现象)
5. **仅在内部网络使用** (不要暴露到公网)

### 获取帮助

**遇到问题:**
1. 运行 `test-lan-connection.bat` 诊断
2. 查看本文档 [故障排除](#故障排除) 章节
3. 检查 [常见问题 FAQ](#常见问题-faq)
4. 查看浏览器控制台 (F12) 和服务日志

**提供反馈:**
- 报告 Bug
- 提出改进建议
- 分享使用经验

---

## 🎉 享受高效协作!

配置完成后,你的团队可以:

- ✨ **流式响应** - 答案实时显示,体验流畅
- 📚 **共享知识库** - 统一的知识来源,答案准确
- 🚀 **即开即用** - 无需安装,浏览器访问
- 📱 **多设备支持** - 电脑、手机、平板都能用
- 🔒 **安全可控** - 内网使用,数据不外泄

Happy Collaborating! 🎊

---

**文档版本**: v1.0  
**最后更新**: 2025年10月30日  
**适用于**: Knowledge Web Client v1.6.5+
