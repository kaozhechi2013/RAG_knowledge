<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowledge - èŠå¤©å®¢æˆ·ç«¯</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Markdown æ¸²æŸ“åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    <!-- ä»£ç é«˜äº®åº“ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css">
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/highlight.min.js"></script>
    <style>
        .message {
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Markdown æ ·å¼ä¼˜åŒ– */
        .markdown-content {
            line-height: 1.6;
        }

        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3,
        .markdown-content h4,
        .markdown-content h5,
        .markdown-content h6 {
            font-weight: 600;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
        }

        .markdown-content h1 {
            font-size: 1.5em;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.3em;
        }

        .markdown-content h2 {
            font-size: 1.3em;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.3em;
        }

        .markdown-content h3 {
            font-size: 1.15em;
        }

        .markdown-content p {
            margin-bottom: 1em;
        }

        .markdown-content ul,
        .markdown-content ol {
            margin-bottom: 1em;
            padding-left: 2em;
        }

        .markdown-content ul {
            list-style-type: disc;
        }

        .markdown-content ol {
            list-style-type: decimal;
        }

        .markdown-content li {
            margin-bottom: 0.25em;
        }

        .markdown-content pre {
            background-color: #f6f8fa;
            border-radius: 6px;
            padding: 1em;
            overflow-x: auto;
            margin-bottom: 1em;
        }

        .markdown-content code {
            background-color: #f6f8fa;
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-size: 0.9em;
            font-family: 'Courier New', monospace;
        }

        .markdown-content pre code {
            background-color: transparent;
            padding: 0;
        }

        .markdown-content blockquote {
            border-left: 4px solid #e5e7eb;
            padding-left: 1em;
            color: #6b7280;
            margin-bottom: 1em;
        }

        .markdown-content table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 1em;
        }

        .markdown-content th,
        .markdown-content td {
            border: 1px solid #e5e7eb;
            padding: 0.5em;
            text-align: left;
        }

        .markdown-content th {
            background-color: #f9fafb;
            font-weight: 600;
        }

        .markdown-content a {
            color: #3b82f6;
            text-decoration: underline;
        }

        .markdown-content a:hover {
            color: #2563eb;
        }

        .markdown-content strong {
            font-weight: 600;
        }

        .markdown-content em {
            font-style: italic;
        }

        .markdown-content hr {
            border: none;
            border-top: 1px solid #e5e7eb;
            margin: 1.5em 0;
        }
    </style>
</head>

<body class="bg-gray-100 h-screen flex flex-col">
    <!-- é¡¶éƒ¨æ  -->
    <div class="bg-white shadow-sm p-4 flex items-center justify-between">
        <h1 class="text-xl font-bold text-gray-800">ğŸ’¬ Knowledge AI åŠ©æ‰‹</h1>
        <div class="flex items-center gap-4">
            <span id="status" class="text-sm text-gray-500">æœªè¿æ¥</span>
            <button onclick="toggleSettings()" class="text-gray-600 hover:text-gray-800">âš™ï¸</button>
        </div>
    </div>

    <!-- è®¾ç½®é¢æ¿ -->
    <div id="settings" class="hidden bg-white border-b p-4">
        <div class="max-w-2xl mx-auto space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">API åœ°å€</label>
                <input type="text" id="apiUrl" placeholder="http://192.168.1.100:8080"
                    class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">API Key</label>
                <input type="password" id="apiKey" placeholder="your-api-key"
                    class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">é€‰æ‹©æ¨¡å‹</label>
                <select id="modelSelect" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="">è¯·å…ˆä¿å­˜è®¾ç½®ä»¥åŠ è½½æ¨¡å‹...</option>
                </select>
                <button onclick="refreshModels()" class="mt-2 text-sm text-blue-600 hover:text-blue-800">
                    ğŸ”„ åˆ·æ–°æ¨¡å‹åˆ—è¡¨
                </button>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    ğŸ“¦ å¯¼å…¥åŠ©æ‰‹é…ç½®
                </label>
                <textarea id="importConfig" rows="6" placeholder='åœ¨ Knowledge æ¡Œé¢åº”ç”¨ä¸­:
1. å³é”®ç‚¹å‡»åŠ©æ‰‹
2. é€‰æ‹© "å¯¼å‡ºWebç«¯é…ç½®"
3. ç²˜è´´åˆ°è¿™é‡Œ
4. ç‚¹å‡»ä¸‹æ–¹"å¯¼å…¥é…ç½®"æŒ‰é’®'
                    class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 font-mono text-sm"></textarea>
                <button onclick="importAssistantConfig()"
                    class="mt-2 w-full bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600">
                    ğŸ“¥ å¯¼å…¥é…ç½®
                </button>
                <div class="mt-2 p-3 bg-blue-50 rounded-lg">
                    <p class="text-xs text-blue-800">
                        <strong>ğŸ’¡ æç¤º:</strong> å¯¼å…¥é…ç½®å,åŠ©æ‰‹IDå’ŒçŸ¥è¯†åº“å°†è‡ªåŠ¨è®¾ç½®,å¯ç›´æ¥å¼€å§‹å¯¹è¯!
                    </p>
                </div>
                <!-- éšè—å­—æ®µç”¨äºå­˜å‚¨åŠ©æ‰‹ID -->
                <input type="hidden" id="assistantId">
            </div>
            <div class="flex gap-2">
                <button onclick="saveSettings()"
                    class="flex-1 bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                    ä¿å­˜è®¾ç½®
                </button>
                <button onclick="testConnection()"
                    class="flex-1 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">
                    æµ‹è¯•è¿æ¥
                </button>
            </div>
        </div>
    </div>

    <!-- èŠå¤©åŒºåŸŸ -->
    <div class="flex-1 overflow-y-auto p-4" id="chatContainer">
        <div class="max-w-3xl mx-auto space-y-4" id="messages">
            <!-- æ¬¢è¿æ¶ˆæ¯ -->
            <div class="bg-white p-4 rounded-lg shadow-sm">
                <div class="markdown-content text-gray-600">
                    <p>ğŸ‘‹ <strong>æ‚¨å¥½!</strong> æˆ‘æ˜¯ Knowledge AI åŠ©æ‰‹,æœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨çš„å—?</p>
                </div>
            </div>
        </div>
    </div>

    <!-- è¾“å…¥åŒºåŸŸ -->
    <div class="bg-white border-t p-4">
        <div class="max-w-3xl mx-auto">
            <div class="flex gap-2">
                <input type="text" id="messageInput" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..."
                    class="flex-1 px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
                    onkeypress="if(event.key==='Enter') sendMessage()">
                <button onclick="sendMessage()"
                    class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 disabled:bg-gray-300" id="sendBtn">
                    å‘é€
                </button>
            </div>
        </div>
    </div>

    <script>
        // é…ç½®
        let config = {
            apiUrl: localStorage.getItem('apiUrl') || 'http://localhost:8080',
            apiKey: localStorage.getItem('apiKey') || '',
            model: localStorage.getItem('model') || 'gpt-4',
            assistantId: localStorage.getItem('assistantId') || '',
            knowledgeBases: JSON.parse(localStorage.getItem('knowledgeBases') || '[]')
        };

        let availableModels = [];

        // åˆå§‹åŒ–
        document.getElementById('apiUrl').value = config.apiUrl;
        document.getElementById('apiKey').value = config.apiKey;
        document.getElementById('assistantId').value = config.assistantId;
        updateStatus();
        refreshModels();

        // åˆ‡æ¢è®¾ç½®é¢æ¿
        function toggleSettings() {
            const settings = document.getElementById('settings');
            settings.classList.toggle('hidden');
            if (!settings.classList.contains('hidden')) {
                refreshModels();
            }
        }

        // å¯¼å…¥åŠ©æ‰‹é…ç½®
        function importAssistantConfig() {
            const textarea = document.getElementById('importConfig');
            const configText = textarea.value.trim();
            
            if (!configText) {
                alert('âš ï¸ è¯·ç²˜è´´é…ç½®å†…å®¹');
                return;
            }
            
            try {
                const importedConfig = JSON.parse(configText);
                
                // éªŒè¯é…ç½®ç»“æ„
                if (!importedConfig.assistantId) {
                    throw new Error('é…ç½®ä¸­ç¼ºå°‘ assistantId');
                }
                
                // æ›´æ–°é…ç½®
                config.assistantId = importedConfig.assistantId;
                config.knowledgeBases = importedConfig.knowledgeBases || [];
                
                // æ›´æ–° UI
                document.getElementById('assistantId').value = config.assistantId;
                
                // ä¿å­˜åˆ° localStorage
                saveSettings();
                
                // æ¸…ç©ºè¾“å…¥æ¡†
                textarea.value = '';
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                alert(`âœ… é…ç½®å¯¼å…¥æˆåŠŸ!\n\nåŠ©æ‰‹: ${importedConfig.assistantName || 'æœªå‘½å'}\nåŠ©æ‰‹ID: ${config.assistantId}\nçŸ¥è¯†åº“æ•°é‡: ${config.knowledgeBases.length}\n\né…ç½®å·²è‡ªåŠ¨ä¿å­˜ï¼Œç°åœ¨å¯ä»¥å¼€å§‹å¯¹è¯äº†ï¼`);
                
            } catch (error) {
                alert(`âŒ é…ç½®å¯¼å…¥å¤±è´¥\n\né”™è¯¯: ${error.message}\n\nè¯·ç¡®ä¿ç²˜è´´çš„æ˜¯ä» Knowledge åº”ç”¨å¯¼å‡ºçš„å®Œæ•´é…ç½®`);
                console.error('å¯¼å…¥é…ç½®å¤±è´¥:', error);
            }
        }

        // åˆ·æ–°æ¨¡å‹åˆ—è¡¨
        async function refreshModels() {
            const selectEl = document.getElementById('modelSelect');
            selectEl.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';

            try {
                const response = await fetch(`${config.apiUrl}/v1/models`, {
                    headers: {
                        'Authorization': `Bearer ${config.apiKey}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                availableModels = data.data || [];

                if (availableModels.length === 0) {
                    selectEl.innerHTML = '<option value="">âš ï¸ æœªæ‰¾åˆ°æ¨¡å‹ï¼Œè¯·åœ¨ Knowledge åº”ç”¨ä¸­é…ç½® LLM æœåŠ¡å•†</option>';
                    alert('âš ï¸ é‡è¦æç¤º\n\næœªæ‰¾åˆ°å¯ç”¨çš„æ¨¡å‹ï¼\n\nè¯·å…ˆåœ¨ Knowledge æ¡Œé¢åº”ç”¨ä¸­ï¼š\n1. è¿›å…¥"è®¾ç½®" â†’ "æœåŠ¡å•†"\n2. æ·»åŠ å¹¶é…ç½®è‡³å°‘ä¸€ä¸ª LLM æœåŠ¡å•†ï¼ˆå¦‚ OpenAIã€Claude ç­‰ï¼‰\n3. ç„¶åå›åˆ°è¿™é‡Œåˆ·æ–°æ¨¡å‹åˆ—è¡¨');
                    return;
                }

                selectEl.innerHTML = '';
                availableModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = `${model.id} (${model.owned_by || 'unknown'})`;
                    if (model.id === config.model) {
                        option.selected = true;
                    }
                    selectEl.appendChild(option);
                });

                // å¦‚æœå½“å‰é€‰æ‹©çš„æ¨¡å‹ä¸åœ¨åˆ—è¡¨ä¸­ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ª
                if (!availableModels.find(m => m.id === config.model)) {
                    config.model = availableModels[0].id;
                    selectEl.value = config.model;
                }

            } catch (error) {
                selectEl.innerHTML = '<option value="">âŒ åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ API è®¾ç½®</option>';
                console.error('è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // æµ‹è¯•è¿æ¥
        async function testConnection() {
            try {
                const response = await fetch(`${config.apiUrl}/v1/models`, {
                    headers: {
                        'Authorization': `Bearer ${config.apiKey}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const count = data.data ? data.data.length : 0;
                    if (count > 0) {
                        alert(`âœ… è¿æ¥æˆåŠŸï¼\n\næ‰¾åˆ° ${count} ä¸ªå¯ç”¨æ¨¡å‹`);
                    } else {
                        alert('âš ï¸ è¿æ¥æˆåŠŸï¼Œä½†æœªæ‰¾åˆ°æ¨¡å‹\n\nè¯·åœ¨ Knowledge åº”ç”¨ä¸­é…ç½® LLM æœåŠ¡å•†');
                    }
                } else {
                    alert(`âŒ è¿æ¥å¤±è´¥\n\nHTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                alert(`âŒ è¿æ¥å¤±è´¥\n\n${error.message}\n\nè¯·æ£€æŸ¥ï¼š\n1. API åœ°å€æ˜¯å¦æ­£ç¡®\n2. Knowledge åº”ç”¨æ˜¯å¦è¿è¡Œ\n3. API Server æ˜¯å¦å·²å¯ç”¨`);
            }
        }

        // ä¿å­˜è®¾ç½®
        function saveSettings() {
            config.apiUrl = document.getElementById('apiUrl').value;
            config.apiKey = document.getElementById('apiKey').value;
            config.assistantId = document.getElementById('assistantId').value.trim();
            const selectedModel = document.getElementById('modelSelect').value;
            if (selectedModel) {
                config.model = selectedModel;
            }

            localStorage.setItem('apiUrl', config.apiUrl);
            localStorage.setItem('apiKey', config.apiKey);
            localStorage.setItem('model', config.model);
            localStorage.setItem('assistantId', config.assistantId);
            localStorage.setItem('knowledgeBases', JSON.stringify(config.knowledgeBases || []));

            toggleSettings();
            updateStatus();
            
            let alertMsg = 'âœ… è®¾ç½®å·²ä¿å­˜ï¼\n\nå½“å‰æ¨¡å‹: ' + config.model;
            if (config.assistantId) {
                alertMsg += '\nåŠ©æ‰‹ID: ' + config.assistantId;
                alertMsg += '\nçŸ¥è¯†åº“æ•°é‡: ' + (config.knowledgeBases?.length || 0);
                if (config.knowledgeBases && config.knowledgeBases.length > 0) {
                    alertMsg += '\n\nğŸ’¡ å°†è‡ªåŠ¨ä½¿ç”¨åŠ©æ‰‹å…³è”çš„çŸ¥è¯†åº“';
                } else {
                    alertMsg += '\n\nâš ï¸ æç¤º: è¯·ä½¿ç”¨"å¯¼å…¥åŠ©æ‰‹é…ç½®"åŠŸèƒ½å¯¼å…¥çŸ¥è¯†åº“é…ç½®';
                }
            } else {
                alertMsg += '\n\nğŸ’¡ æç¤º: ä½¿ç”¨"å¯¼å…¥åŠ©æ‰‹é…ç½®"å¯å¯ç”¨çŸ¥è¯†åº“åŠŸèƒ½';
            }
            alert(alertMsg);
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€
        async function updateStatus() {
            const statusEl = document.getElementById('status');
            try {
                const response = await fetch(`${config.apiUrl}/v1/models`, {
                    headers: {
                        'Authorization': `Bearer ${config.apiKey}`
                    }
                });
                if (response.ok) {
                    const data = await response.json();
                    const count = data.data ? data.data.length : 0;
                    statusEl.textContent = count > 0 ? `âœ… å·²è¿æ¥ (${count} æ¨¡å‹)` : 'âš ï¸ å·²è¿æ¥ (æ— æ¨¡å‹)';
                    statusEl.className = count > 0 ? 'text-sm text-green-600' : 'text-sm text-yellow-600';
                } else {
                    statusEl.textContent = 'âŒ è¿æ¥å¤±è´¥';
                    statusEl.className = 'text-sm text-red-600';
                }
            } catch (error) {
                statusEl.textContent = 'âŒ æ— æ³•è¿æ¥';
                statusEl.className = 'text-sm text-red-600';
            }
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢
        function addMessage(content, isUser = false) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isUser ? 'text-right' : ''}`;

            const bubble = document.createElement('div');
            bubble.className = `inline-block max-w-xl p-4 rounded-lg ${isUser
                    ? 'bg-blue-500 text-white'
                    : 'bg-white shadow-sm text-gray-800'
                }`;
            
            // ç”¨æˆ·æ¶ˆæ¯ä½¿ç”¨çº¯æ–‡æœ¬,AI æ¶ˆæ¯ä½¿ç”¨ Markdown æ¸²æŸ“
            if (isUser) {
                bubble.textContent = content;
            } else {
                bubble.className += ' markdown-content';
                // é…ç½® marked é€‰é¡¹
                marked.setOptions({
                    breaks: true, // æ”¯æŒæ¢è¡Œ
                    gfm: true, // GitHub Flavored Markdown
                    highlight: function(code, lang) {
                        if (lang && hljs.getLanguage(lang)) {
                            try {
                                return hljs.highlight(code, { language: lang }).value;
                            } catch (err) {}
                        }
                        return hljs.highlightAuto(code).value;
                    }
                });
                bubble.innerHTML = marked.parse(content);
            }

            messageDiv.appendChild(bubble);
            messagesDiv.appendChild(messageDiv);

            // æ»šåŠ¨åˆ°åº•éƒ¨
            document.getElementById('chatContainer').scrollTop =
                document.getElementById('chatContainer').scrollHeight;
        }

        // å‘é€æ¶ˆæ¯ (æµå¼å“åº”ç‰ˆæœ¬)
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            const message = input.value.trim();

            if (!message) return;

            // æ£€æŸ¥æ˜¯å¦æœ‰å¯ç”¨æ¨¡å‹
            if (!config.model || config.model === '') {
                alert('âš ï¸ è¯·å…ˆé…ç½®æ¨¡å‹\n\nç‚¹å‡»å³ä¸Šè§’ âš™ï¸ è®¾ç½®ï¼Œé€‰æ‹©ä¸€ä¸ªå¯ç”¨çš„æ¨¡å‹');
                toggleSettings();
                return;
            }

            // ç¦ç”¨è¾“å…¥
            input.disabled = true;
            sendBtn.disabled = true;

            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            addMessage(message, true);
            input.value = '';

            // åˆ›å»º AI å›å¤å®¹å™¨
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';

            const bubble = document.createElement('div');
            bubble.className = 'inline-block max-w-xl p-4 rounded-lg bg-white shadow-sm text-gray-800 markdown-content';
            bubble.id = 'streaming-message';
            
            // æ ¹æ®æ˜¯å¦ä½¿ç”¨çŸ¥è¯†åº“æ˜¾ç¤ºä¸åŒçš„åŠ è½½æç¤º
            const hasKnowledgeBase = config.knowledgeBases && config.knowledgeBases.length > 0;
            bubble.innerHTML = hasKnowledgeBase 
                ? '<span class="text-blue-600">ğŸ” æ­£åœ¨æœç´¢çŸ¥è¯†åº“...</span>'
                : '<span class="text-gray-400">â³ æ­£åœ¨æ€è€ƒ...</span>';

            messageDiv.appendChild(bubble);
            messagesDiv.appendChild(messageDiv);

            // æ»šåŠ¨åˆ°åº•éƒ¨
            const scrollToBottom = () => {
                const container = document.getElementById('chatContainer');
                container.scrollTop = container.scrollHeight;
            };
            scrollToBottom();

            try {
                // æ„é€ è¯·æ±‚ä½“
                const requestBody = {
                    model: config.model,
                    messages: [
                        { role: 'user', content: message }
                    ],
                    stream: true  // å¯ç”¨æµå¼å“åº”
                };

                // å¦‚æœè®¾ç½®äº†åŠ©æ‰‹IDï¼Œæ·»åŠ åˆ°è¯·æ±‚ä¸­
                if (config.assistantId) {
                    requestBody.assistant_id = config.assistantId;
                }
                
                // å¦‚æœæœ‰çŸ¥è¯†åº“é…ç½®ï¼Œæ·»åŠ åˆ°è¯·æ±‚ä¸­
                if (config.knowledgeBases && config.knowledgeBases.length > 0) {
                    requestBody.knowledge_bases = config.knowledgeBases;
                }

                // è¯¦ç»†æ—¥å¿—
                console.group('ğŸ“¤ å‘é€æµå¼è¯·æ±‚');
                console.log('URL:', `${config.apiUrl}/v1/chat/completions`);
                console.log('Model:', config.model);
                console.log('Stream:', true);
                console.log('Assistant ID:', config.assistantId || 'âŒ æœªè®¾ç½®');
                console.log('Knowledge Bases:', config.knowledgeBases?.length || 0);
                console.groupEnd();

                // è®°å½•å¼€å§‹æ—¶é—´
                const startTime = Date.now();
                let firstTokenTime = null;
                let fullContent = '';

                // è°ƒç”¨ API (æµå¼)
                const response = await fetch(`${config.apiUrl}/v1/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${config.apiKey}`
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('âŒ API é”™è¯¯å“åº”:', errorText);
                    throw new Error(`API é”™è¯¯ ${response.status}: ${errorText}`);
                }

                // å¤„ç†æµå¼å“åº”
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                console.log('ğŸ“¥ å¼€å§‹æ¥æ”¶æµå¼æ•°æ®...');

                while (true) {
                    const { done, value } = await reader.read();
                    
                    if (done) {
                        console.log('âœ… æµå¼å“åº”å®Œæˆ');
                        break;
                    }

                    // è§£ç æ•°æ®å—
                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.trim() === '') continue;
                        if (line.trim() === 'data: [DONE]') continue;
                        
                        if (line.startsWith('data: ')) {
                            try {
                                const jsonStr = line.slice(6); // ç§»é™¤ "data: " å‰ç¼€
                                const data = JSON.parse(jsonStr);
                                
                                // æå–å†…å®¹
                                if (data.choices && data.choices[0]?.delta?.content) {
                                    const content = data.choices[0].delta.content;
                                    fullContent += content;
                                    
                                    // è®°å½•é¦–ä¸ª token æ—¶é—´
                                    if (!firstTokenTime) {
                                        firstTokenTime = Date.now();
                                        const timeToFirstToken = ((firstTokenTime - startTime) / 1000).toFixed(2);
                                        console.log(`âš¡ é¦–ä¸ª token æ—¶é—´: ${timeToFirstToken} ç§’`);
                                    }
                                    
                                    // å®æ—¶æ¸²æŸ“ Markdown
                                    bubble.innerHTML = marked.parse(fullContent);
                                    scrollToBottom();
                                }
                            } catch (e) {
                                // å¿½ç•¥è§£æé”™è¯¯ï¼Œç»§ç»­å¤„ç†ä¸‹ä¸€è¡Œ
                            }
                        }
                    }
                }

                // è®¡ç®—æ€»æ—¶é—´
                const endTime = Date.now();
                const totalTime = ((endTime - startTime) / 1000).toFixed(2);
                const generationTime = firstTokenTime ? ((endTime - firstTokenTime) / 1000).toFixed(2) : '0';
                
                console.group('ğŸ“Š æ€§èƒ½ç»Ÿè®¡');
                console.log(`â±ï¸ æ€»æ—¶é—´: ${totalTime} ç§’`);
                console.log(`âš¡ é¦–ä¸ª token: ${((firstTokenTime - startTime) / 1000).toFixed(2)} ç§’`);
                console.log(`âœï¸ ç”Ÿæˆæ—¶é—´: ${generationTime} ç§’`);
                console.log(`ğŸ“ å†…å®¹é•¿åº¦: ${fullContent.length} å­—ç¬¦`);
                console.groupEnd();

                // ç§»é™¤ä¸´æ—¶ ID
                bubble.removeAttribute('id');

            } catch (error) {
                console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                
                // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                const bubble = document.getElementById('streaming-message');
                if (bubble) {
                    let errorMsg = `âŒ é”™è¯¯: ${error.message}`;
                    if (error.message.includes('API é”™è¯¯')) {
                        errorMsg += '\n\nå¯èƒ½çš„åŸå› :\n1. æ¨¡å‹æœªé…ç½®æˆ–ä¸å¯ç”¨\n2. API Key é”™è¯¯\n3. ç½‘ç»œé—®é¢˜';
                    }
                    bubble.innerHTML = `<pre class="whitespace-pre-wrap">${errorMsg}</pre>`;
                    bubble.removeAttribute('id');
                }
            } finally {
                // æ¢å¤è¾“å…¥
                input.disabled = false;
                sendBtn.disabled = false;
                input.focus();
            }
        }

        // å®šæœŸæ£€æŸ¥è¿æ¥çŠ¶æ€
        setInterval(updateStatus, 30000);
    </script>
</body>

</html>