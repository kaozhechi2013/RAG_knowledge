<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowledge - èŠå¤©å®¢æˆ·ç«¯</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Markdown æ¸²æŸ“åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>
    <!-- ä»£ç é«˜äº®åº“ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/styles/github.min.css">
    <script src="https://cdn.jsdelivr.net/npm/highlight.js@11.9.0/highlight.min.js"></script>
    <!-- KaTeX æ•°å­¦å…¬å¼æ¸²æŸ“ -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <style>
        .message {
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Markdown æ ·å¼ä¼˜åŒ– */
        .markdown-content {
            line-height: 1.6;
        }

        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3,
        .markdown-content h4,
        .markdown-content h5,
        .markdown-content h6 {
            font-weight: 600;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
        }

        .markdown-content h1 {
            font-size: 1.5em;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 0.3em;
        }

        .markdown-content h2 {
            font-size: 1.3em;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.3em;
        }

        .markdown-content h3 {
            font-size: 1.15em;
        }

        .markdown-content p {
            margin-bottom: 1em;
        }

        .markdown-content ul,
        .markdown-content ol {
            margin-bottom: 1em;
            padding-left: 2em;
        }

        .markdown-content ul {
            list-style-type: disc;
        }

        .markdown-content ol {
            list-style-type: decimal;
        }

        .markdown-content li {
            margin-bottom: 0.25em;
        }

        .markdown-content pre {
            background-color: #f6f8fa;
            border-radius: 6px;
            padding: 1em;
            overflow-x: auto;
            margin-bottom: 1em;
        }

        .markdown-content code {
            background-color: #f6f8fa;
            padding: 0.2em 0.4em;
            border-radius: 3px;
            font-size: 0.9em;
            font-family: 'Courier New', monospace;
        }

        .markdown-content pre code {
            background-color: transparent;
            padding: 0;
        }

        .markdown-content blockquote {
            border-left: 4px solid #e5e7eb;
            padding-left: 1em;
            color: #6b7280;
            margin-bottom: 1em;
        }

        .markdown-content table {
            border-collapse: collapse;
            width: 100%;
            margin-bottom: 1em;
        }

        .markdown-content th,
        .markdown-content td {
            border: 1px solid #e5e7eb;
            padding: 0.5em;
            text-align: left;
        }

        .markdown-content th {
            background-color: #f9fafb;
            font-weight: 600;
        }

        .markdown-content a {
            color: #3b82f6;
            text-decoration: underline;
        }

        .markdown-content a:hover {
            color: #2563eb;
        }

        .markdown-content strong {
            font-weight: 600;
        }

        .markdown-content em {
            font-style: italic;
        }

        .markdown-content hr {
            border: none;
            border-top: 1px solid #e5e7eb;
            margin: 1.5em 0;
        }

        /* å¼•ç”¨æ ‡æ³¨æ ·å¼ - æ¨¡ä»¿ Cherry Studio */
        .citation {
            display: inline-block;
            background-color: #3b82f6;
            color: white;
            font-size: 0.7em;
            font-weight: 600;
            padding: 0.15em 0.5em;
            border-radius: 0.3em;
            margin: 0 0.15em;
            cursor: pointer;
            text-decoration: none;
            vertical-align: super;
            line-height: 1.2;
            transition: all 0.2s ease;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .citation:hover {
            background-color: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }

        .citation:active {
            transform: translateY(0);
        }

        /* å¼•ç”¨å¼¹çª— - æ¨¡ä»¿ Cherry Studio */
        .citation-tooltip {
            position: fixed;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 0;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            max-width: 450px;
            min-width: 300px;
            z-index: 1000;
            display: none;
            overflow: hidden;
        }

        .citation-tooltip.show {
            display: block;
            animation: tooltipFadeIn 0.2s ease;
        }

        @keyframes tooltipFadeIn {
            from {
                opacity: 0;
                transform: translateY(-5px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .citation-tooltip-header {
            background: #f9fafb;
            border-bottom: 1px solid #e5e7eb;
            padding: 12px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .citation-tooltip-icon {
            font-size: 1.2em;
        }

        .citation-title {
            font-weight: 600;
            color: #1f2937;
            font-size: 0.9em;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .citation-content {
            color: #4b5563;
            font-size: 0.85em;
            line-height: 1.6;
            max-height: 250px;
            overflow-y: auto;
            padding: 16px;
            background: white;
        }

        .citation-content::-webkit-scrollbar {
            width: 6px;
        }

        .citation-content::-webkit-scrollbar-track {
            background: #f3f4f6;
        }

        .citation-content::-webkit-scrollbar-thumb {
            background: #d1d5db;
            border-radius: 3px;
        }

        .citation-url {
            color: #3b82f6;
            font-size: 0.75em;
            padding: 10px 16px;
            border-top: 1px solid #f3f4f6;
            background: #fafbfc;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .citation-url:hover {
            background: #f3f4f6;
        }

        .citation-badge {
            display: inline-block;
            background: #dbeafe;
            color: #1e40af;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
        }

        /* å¼•ç”¨åˆ—è¡¨æ ·å¼ */
        .citations-list {
            padding: 16px;
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.9em;
        }

        .citations-list-title {
            font-weight: 600;
            color: #374151;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .citation-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 12px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .citation-item:hover {
            background: #f3f4f6;
            border-color: #3b82f6;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .citation-item-number {
            flex-shrink: 0;
            width: 24px;
            height: 24px;
            background: #3b82f6;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8em;
            font-weight: 600;
        }

        .citation-item-content {
            flex: 1;
            min-width: 0;
        }

        .citation-item-title {
            font-weight: 500;
            color: #1f2937;
            margin-bottom: 4px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .citation-item-preview {
            font-size: 0.85em;
            color: #6b7280;
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .citation-item-meta {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
            font-size: 0.75em;
            color: #9ca3af;
        }

        .no-citations {
            text-align: center;
            color: #9ca3af;
            padding: 16px;
            font-size: 0.9em;
        }

        /* KaTeX æ•°å­¦å…¬å¼æ ·å¼ä¼˜åŒ– */
        .katex {
            font-size: 1.1em;
        }

        .katex-display {
            margin: 1em 0;
            overflow-x: auto;
            overflow-y: hidden;
        }
    </style>
</head>

<body class="bg-gray-100 h-screen flex flex-col">
    <!-- é¡¶éƒ¨æ  -->
    <div class="bg-white shadow-sm p-4 flex items-center justify-between">
        <h1 class="text-xl font-bold text-gray-800">ğŸ’¬ Knowledge AI åŠ©æ‰‹</h1>
        <div class="flex items-center gap-4">
            <span id="status" class="text-sm text-gray-500">æœªè¿æ¥</span>
            <button onclick="toggleSettings()" class="text-gray-600 hover:text-gray-800">âš™ï¸</button>
        </div>
    </div>

    <!-- è®¾ç½®é¢æ¿ -->
    <div id="settings" class="hidden bg-white border-b p-4">
        <div class="max-w-2xl mx-auto space-y-4">
            <div class="p-3 bg-green-50 border border-green-200 rounded-lg mb-4">
                <p class="text-sm text-green-800">
                    âœ… <strong>é›¶é…ç½®æ¨¡å¼</strong> - API Key å·²å†…ç½®ï¼ŒåŠ©æ‰‹é…ç½®å·²é¢„è®¾ï¼Œæ‰“å¼€å³ç”¨
                </p>
                <p class="text-xs text-green-700 mt-1">
                    ğŸ”’ æœåŠ¡å™¨å·²å¯ç”¨è®¤è¯ä¿æŠ¤ | ğŸ“š é»˜è®¤çŸ¥è¯†åº“ï¼šé€æ˜åœ°è´¨ã€å·¥ä½œæ€»ç»“ã€æµ‘æºå¯ç ”ç­‰
                </p>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    API åœ°å€ <span class="text-xs text-gray-500">(å·²è‡ªåŠ¨æ£€æµ‹)</span>
                </label>
                <input type="text" id="apiUrl" placeholder="http://10.216.186.24:8080"
                    class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                <p class="mt-1 text-xs text-gray-500">
                    ğŸ’¡ ç³»ç»Ÿè‡ªåŠ¨æ£€æµ‹ï¼š<br>
                    â€¢ ç®¡ç†å‘˜ï¼ˆæœ¬æœºï¼‰ï¼šhttp://localhost:8080<br>
                    â€¢ åŒäº‹è®¿é—®ï¼šhttp://10.216.186.24:8080<br>
                    ä¸€èˆ¬æ— éœ€ä¿®æ”¹
                </p>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">é€‰æ‹©æ¨¡å‹</label>
                <select id="modelSelect" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500">
                    <option value="">è¯·å…ˆä¿å­˜è®¾ç½®ä»¥åŠ è½½æ¨¡å‹...</option>
                </select>
                <button onclick="refreshModels()" class="mt-2 text-sm text-blue-600 hover:text-blue-800">
                    ğŸ”„ åˆ·æ–°æ¨¡å‹åˆ—è¡¨
                </button>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                    ğŸ“¦ æ›´æ–°åŠ©æ‰‹é…ç½®ï¼ˆé«˜çº§åŠŸèƒ½ï¼‰
                </label>
                <textarea id="importConfig" rows="6" placeholder='âœ… ç³»ç»Ÿå·²é¢„è®¾é»˜è®¤åŠ©æ‰‹é…ç½®

ä»…åœ¨ä»¥ä¸‹æƒ…å†µéœ€è¦é‡æ–°å¯¼å…¥ï¼š
â€¢ ç®¡ç†å‘˜ä¿®æ”¹äº†çŸ¥è¯†åº“çš„ Embedding æ¨¡å‹
â€¢ ç®¡ç†å‘˜ä¿®æ”¹äº†é‡æ’åºæ¨¡å‹é…ç½®
â€¢ éœ€è¦åˆ‡æ¢åˆ°å…¶ä»–åŠ©æ‰‹

ğŸ’¡ æ³¨æ„ï¼šç®¡ç†å‘˜æ–°å¢/åˆ é™¤æ–‡æ¡£æ— éœ€é‡æ–°å¯¼å…¥ï¼
æ–‡æ¡£å˜åŒ–ä¼šè‡ªåŠ¨åŒæ­¥ï¼Œä¸‹æ¬¡æé—®å³å¯æœç´¢åˆ°æ–°å†…å®¹ã€‚

å¯¼å…¥æ­¥éª¤ï¼š
1. åœ¨ Knowledge æ¡Œé¢åº”ç”¨ä¸­å³é”®ç‚¹å‡»åŠ©æ‰‹
2. é€‰æ‹© "å¯¼å‡ºWebç«¯é…ç½®"
3. ç²˜è´´åˆ°è¿™é‡Œ
4. ç‚¹å‡»ä¸‹æ–¹"å¯¼å…¥é…ç½®"æŒ‰é’®'
                    class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 font-mono text-sm"></textarea>
                <button onclick="importAssistantConfig()"
                    class="mt-2 w-full bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600">
                    ğŸ“¥ å¯¼å…¥é…ç½®
                </button>
                <!-- éšè—å­—æ®µç”¨äºå­˜å‚¨åŠ©æ‰‹IDå’ŒAPI Keyï¼ˆå·²åºŸå¼ƒï¼Œä¿ç•™å…¼å®¹æ€§ï¼‰ -->
                <input type="hidden" id="assistantId">
                <input type="hidden" id="apiKey">
            </div>
            <div class="flex gap-2">
                <button onclick="saveSettings()"
                    class="flex-1 bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">
                    ä¿å­˜è®¾ç½®
                </button>
                <button onclick="testConnection()"
                    class="flex-1 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">
                    æµ‹è¯•è¿æ¥
                </button>
            </div>
        </div>
    </div>

    <!-- èŠå¤©åŒºåŸŸ -->
    <div class="flex-1 overflow-y-auto p-4" id="chatContainer">
        <div class="mx-auto space-y-4" id="messages" style="max-width: 1200px; padding: 0 20px;">
            <!-- æ¬¢è¿æ¶ˆæ¯ -->
            <div class="bg-white p-4 rounded-lg shadow-sm">
                <div class="markdown-content text-gray-600">
                    <p>ğŸ‘‹ <strong>æ‚¨å¥½!</strong> æˆ‘æ˜¯ Knowledge AI åŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨çš„å—ï¼Ÿ</p>
                </div>
            </div>
        </div>
    </div>

    <!-- è¾“å…¥åŒºåŸŸ -->
    <div class="bg-white border-t p-4">
        <div class="mx-auto" style="max-width: 1200px; padding: 0 20px;">
            <div class="flex gap-2">
                <input type="text" id="messageInput" placeholder="è¾“å…¥æ‚¨çš„é—®é¢˜..."
                    class="flex-1 px-4 py-3 border rounded-lg focus:ring-2 focus:ring-blue-500"
                    onkeypress="if(event.key==='Enter') sendMessage()">
                <button onclick="clearAllMessages()"
                    class="bg-red-500 text-white px-4 py-3 rounded-lg hover:bg-red-600"
                    title="æ¸…é™¤æ‰€æœ‰èŠå¤©è®°å½•">
                    ğŸ—‘ï¸ æ¸…é™¤
                </button>
                <button onclick="sendMessage()"
                    class="bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 disabled:bg-gray-300" id="sendBtn">
                    å‘é€
                </button>
            </div>
        </div>
    </div>

    <script>
        // é…ç½®
        // å†…éƒ¨ä½¿ç”¨çš„å›ºå®š API Keyï¼ˆç”¨æˆ·æ— éœ€é…ç½®ï¼‰
        const INTERNAL_API_KEY = 'cs-sk-23b57a53-e400-4068-96c4-339bbb380554';
        
        // é»˜è®¤åŠ©æ‰‹é…ç½®ï¼ˆä»æ¡Œé¢åº”ç”¨å¯¼å‡ºï¼‰
        const DEFAULT_ASSISTANT_CONFIG = {
            "assistantId": "b2491632-7f94-4656-816e-9bab0e7f442c",
            "assistantName": "é»˜è®¤åŠ©æ‰‹",
            "knowledgeBases": [
                {
                    "id": "g_s0Ra6E9hJyzlTckLivx",
                    "name": "æµ‹è¯•",
                    "model": {
                        "id": "BAAI/bge-m3",
                        "name": "BAAI/bge-m3",
                        "provider": "silicon",
                        "group": "BAAI"
                    },
                    "items": [
                        {
                            "id": "a69ef241-4c68-4812-8927-a2888daa2d33",
                            "type": "file",
                            "content": {
                                "id": "9ae8aa7e-0172-41ba-9526-4dc32c2ccc37",
                                "origin_name": "00é€æ˜åœ°è´¨å¹³å°æ“ä½œæŒ‡å—V1.2.docx",
                                "name": "9ae8aa7e-0172-41ba-9526-4dc32c2ccc37.docx",
                                "path": "C:\\Users\\29193\\AppData\\Roaming\\knowledgeDev\\Data\\Files\\9ae8aa7e-0172-41ba-9526-4dc32c2ccc37.docx",
                                "created_at": "2025-10-29T08:46:56.528Z",
                                "size": 195787,
                                "ext": ".docx",
                                "type": "document",
                                "count": 1
                            },
                            "created_at": 1761727616639,
                            "updated_at": 1761727616639,
                            "uniqueId": "LocalPathLoader_dbfb04ad5a1b5159dd6c91ff7959a903",
                            "uniqueIds": [
                                "LocalPathLoader_dbfb04ad5a1b5159dd6c91ff7959a903"
                            ],
                            "isPreprocessed": true
                        },
                        {
                            "id": "ab5a2273-e271-4e07-bdac-495d2bb1b2d6",
                            "type": "file",
                            "content": {
                                "id": "e868c123-a527-496e-9261-d272f6017053",
                                "origin_name": "2025å·¥ä½œæ€»ç»“å’Œå±•æœ›â€”å¼ ä¼Ÿæ°.docx",
                                "name": "e868c123-a527-496e-9261-d272f6017053.docx",
                                "path": "C:\\Users\\29193\\AppData\\Roaming\\knowledgeDev\\Data\\Files\\e868c123-a527-496e-9261-d272f6017053.docx",
                                "created_at": "2025-10-29T08:46:56.529Z",
                                "size": 19036,
                                "ext": ".docx",
                                "type": "document",
                                "count": 1
                            },
                            "created_at": 1761727616639,
                            "updated_at": 1761727616639,
                            "uniqueId": "LocalPathLoader_d5f24d6dcb6e0e5459a3b8f3320b695a",
                            "uniqueIds": [
                                "LocalPathLoader_d5f24d6dcb6e0e5459a3b8f3320b695a"
                            ],
                            "isPreprocessed": true
                        },
                        {
                            "id": "50f93c4a-0cb6-4416-9deb-188d9938baf7",
                            "type": "file",
                            "content": {
                                "id": "de39414c-e739-4ef4-8749-48d55ed5a556",
                                "origin_name": "æµ‘æºå¯ç ”.docx",
                                "name": "de39414c-e739-4ef4-8749-48d55ed5a556.docx",
                                "path": "C:\\Users\\29193\\AppData\\Roaming\\knowledgeDev\\Data\\Files\\de39414c-e739-4ef4-8749-48d55ed5a556.docx",
                                "created_at": "2025-10-29T08:46:56.529Z",
                                "size": 546890,
                                "ext": ".docx",
                                "type": "document",
                                "count": 1
                            },
                            "created_at": 1761727616639,
                            "updated_at": 1761727616639,
                            "uniqueId": "LocalPathLoader_1ffe9afb0cef6b2acd2e2650fe116842",
                            "uniqueIds": [
                                "LocalPathLoader_1ffe9afb0cef6b2acd2e2650fe116842"
                            ],
                            "isPreprocessed": true
                        },
                        {
                            "id": "2ebe4aa4-90b3-4bdc-b881-8a6ff26ff584",
                            "type": "file",
                            "content": {
                                "id": "81c2f07c-1226-495f-8414-b4769a7ab912",
                                "origin_name": "è¾½å®åº„æ²³æŠ½æ°´è“„èƒ½ç”µç«™.docx",
                                "name": "81c2f07c-1226-495f-8414-b4769a7ab912.docx",
                                "path": "C:\\Users\\29193\\AppData\\Roaming\\knowledgeDev\\Data\\Files\\81c2f07c-1226-495f-8414-b4769a7ab912.docx",
                                "created_at": "2025-10-29T08:46:56.530Z",
                                "size": 803566,
                                "ext": ".docx",
                                "type": "document",
                                "count": 1
                            },
                            "created_at": 1761727616639,
                            "updated_at": 1761727616639,
                            "uniqueId": "LocalPathLoader_547a33243163113357d90081e2189b9c",
                            "uniqueIds": [
                                "LocalPathLoader_547a33243163113357d90081e2189b9c"
                            ],
                            "isPreprocessed": true
                        },
                        {
                            "id": "bbfa5ffb-f5e7-4547-a1c1-80b5f0414121",
                            "type": "file",
                            "content": {
                                "id": "6fad2d07-6fe4-431c-a3b3-8c74946268ce",
                                "origin_name": "æ•°å­—å·¥ç¨‹æ‰€2025å¹´ç ”å‘è®¡åˆ’.xlsx",
                                "name": "6fad2d07-6fe4-431c-a3b3-8c74946268ce.xlsx",
                                "path": "C:\\Users\\29193\\AppData\\Roaming\\knowledgeDev\\Data\\Files\\6fad2d07-6fe4-431c-a3b3-8c74946268ce.xlsx",
                                "created_at": "2025-10-29T08:46:56.531Z",
                                "size": 13334,
                                "ext": ".xlsx",
                                "type": "document",
                                "count": 1
                            },
                            "created_at": 1761727616639,
                            "updated_at": 1761727616639,
                            "uniqueId": "LocalPathLoader_02c82d728865410929c9df6ac6171cfa",
                            "uniqueIds": [
                                "LocalPathLoader_02c82d728865410929c9df6ac6171cfa"
                            ],
                            "isPreprocessed": true
                        }
                    ],
                    "created_at": 1761727605439,
                    "updated_at": 1761727616640,
                    "version": 1,
                    "preprocessProvider": {
                        "type": "preprocess",
                        "provider": {
                            "id": "mineru",
                            "name": "MinerU",
                            "apiKey": "",
                            "apiHost": "https://mineru.net"
                        }
                    },
                    "rerankModel": {
                        "id": "BAAI/bge-reranker-v2-m3",
                        "provider": "silicon",
                        "name": "BAAI/bge-reranker-v2-m3",
                        "group": "baai",
                        "supported_text_delta": true
                    }
                }
            ]
        };
        
        // æ™ºèƒ½ API åœ°å€æ£€æµ‹
        function getDefaultApiUrl() {
            const hostname = window.location.hostname;
            
            // å¦‚æœæ˜¯é€šè¿‡ 10.216.186.24 è®¿é—®ï¼Œä½¿ç”¨åŒæ ·çš„ IP
            if (hostname === '10.216.186.24') {
                return 'http://10.216.186.24:8080';
            }
            
            // å¦‚æœæ˜¯é€šè¿‡å…¶ä»–å±€åŸŸç½‘ IP è®¿é—®ï¼Œä½¿ç”¨è¯¥ IP
            if (hostname !== 'localhost' && hostname !== '127.0.0.1') {
                return `http://${hostname}:8080`;
            }
            
            // æœ¬æœºè®¿é—®ï¼Œé»˜è®¤ä½¿ç”¨ localhost
            return 'http://localhost:8080';
        }

        // åˆå§‹åŒ–é…ç½®ï¼ˆé¦–æ¬¡è®¿é—®æ—¶ä½¿ç”¨é»˜è®¤é…ç½®ï¼‰
        function initializeConfig() {
            const isFirstVisit = !localStorage.getItem('configInitialized');
            
            if (isFirstVisit) {
                // é¦–æ¬¡è®¿é—®ï¼Œä½¿ç”¨é»˜è®¤é…ç½®
                console.log('ğŸ‰ é¦–æ¬¡è®¿é—®ï¼ŒåŠ è½½é»˜è®¤é…ç½®...');
                console.log('ğŸ“š çŸ¥è¯†åº“æ•°é‡:', DEFAULT_ASSISTANT_CONFIG.knowledgeBases.length);
                console.log('ğŸ“„ åŒ…å«æ–‡æ¡£:', DEFAULT_ASSISTANT_CONFIG.knowledgeBases[0]?.items.map(item => item.content.origin_name));
                localStorage.setItem('assistantId', DEFAULT_ASSISTANT_CONFIG.assistantId);
                localStorage.setItem('knowledgeBases', JSON.stringify(DEFAULT_ASSISTANT_CONFIG.knowledgeBases));
                localStorage.setItem('configInitialized', 'true');
                console.log('âœ… é»˜è®¤é…ç½®å·²åŠ è½½ - æ— éœ€æ‰‹åŠ¨é…ç½®ï¼Œå³å¯å¼€å§‹ä½¿ç”¨ï¼');
            } else {
                console.log('â„¹ï¸ ä½¿ç”¨å·²ä¿å­˜çš„é…ç½®');
            }
            
            const apiUrl = localStorage.getItem('apiUrl') || getDefaultApiUrl();
            console.log('ğŸŒ API åœ°å€:', apiUrl);
            
            return {
                apiUrl: apiUrl,
                model: localStorage.getItem('model') || 'deepseek-chat',
                assistantId: localStorage.getItem('assistantId') || DEFAULT_ASSISTANT_CONFIG.assistantId,
                knowledgeBases: JSON.parse(localStorage.getItem('knowledgeBases') || JSON.stringify(DEFAULT_ASSISTANT_CONFIG.knowledgeBases))
            };
        }

        let config = initializeConfig();
        let availableModels = [];

        // åˆå§‹åŒ–
        document.getElementById('apiUrl').value = config.apiUrl;
        document.getElementById('assistantId').value = config.assistantId;
        updateStatus();
        refreshModels();

        // åˆ‡æ¢è®¾ç½®é¢æ¿
        function toggleSettings() {
            const settings = document.getElementById('settings');
            settings.classList.toggle('hidden');
            if (!settings.classList.contains('hidden')) {
                refreshModels();
            }
        }

        // å¯¼å…¥åŠ©æ‰‹é…ç½®
        function importAssistantConfig() {
            const textarea = document.getElementById('importConfig');
            const configText = textarea.value.trim();
            
            if (!configText) {
                alert('âš ï¸ è¯·ç²˜è´´é…ç½®å†…å®¹');
                return;
            }
            
            try {
                const importedConfig = JSON.parse(configText);
                
                // éªŒè¯é…ç½®ç»“æ„
                if (!importedConfig.assistantId) {
                    throw new Error('é…ç½®ä¸­ç¼ºå°‘ assistantId');
                }
                
                // æ›´æ–°é…ç½®
                config.assistantId = importedConfig.assistantId;
                config.knowledgeBases = importedConfig.knowledgeBases || [];
                
                // æ›´æ–° UI
                document.getElementById('assistantId').value = config.assistantId;
                
                // ä¿å­˜åˆ° localStorage
                saveSettings();
                
                // æ¸…ç©ºè¾“å…¥æ¡†
                textarea.value = '';
                
                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                alert(`âœ… é…ç½®å¯¼å…¥æˆåŠŸ!\n\nåŠ©æ‰‹: ${importedConfig.assistantName || 'æœªå‘½å'}\nåŠ©æ‰‹ID: ${config.assistantId}\nçŸ¥è¯†åº“æ•°é‡: ${config.knowledgeBases.length}\n\né…ç½®å·²è‡ªåŠ¨ä¿å­˜ï¼Œç°åœ¨å¯ä»¥å¼€å§‹å¯¹è¯äº†ï¼`);
                
            } catch (error) {
                alert(`âŒ é…ç½®å¯¼å…¥å¤±è´¥\n\né”™è¯¯: ${error.message}\n\nè¯·ç¡®ä¿ç²˜è´´çš„æ˜¯ä» Knowledge åº”ç”¨å¯¼å‡ºçš„å®Œæ•´é…ç½®`);
                console.error('å¯¼å…¥é…ç½®å¤±è´¥:', error);
            }
        }

        // åˆ·æ–°æ¨¡å‹åˆ—è¡¨
        async function refreshModels() {
            // è¯»å–è¾“å…¥æ¡†çš„å½“å‰å€¼
            const apiUrl = document.getElementById('apiUrl').value.trim();

            if (!apiUrl) {
                const selectEl = document.getElementById('modelSelect');
                selectEl.innerHTML = '<option value="">âš ï¸ è¯·å…ˆå¡«å†™ API åœ°å€</option>';
                return;
            }

            const selectEl = document.getElementById('modelSelect');
            selectEl.innerHTML = '<option value="">åŠ è½½ä¸­...</option>';

            try {
                const response = await fetch(`${apiUrl}/v1/models`, {
                    headers: {
                        'Authorization': `Bearer ${INTERNAL_API_KEY}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                availableModels = data.data || [];

                if (availableModels.length === 0) {
                    selectEl.innerHTML = '<option value="">âš ï¸ æœªæ‰¾åˆ°æ¨¡å‹ï¼Œè¯·åœ¨ Knowledge åº”ç”¨ä¸­é…ç½® LLM æœåŠ¡å•†</option>';
                    alert('âš ï¸ é‡è¦æç¤º\n\næœªæ‰¾åˆ°å¯ç”¨çš„æ¨¡å‹ï¼\n\nè¯·å…ˆåœ¨ Knowledge æ¡Œé¢åº”ç”¨ä¸­ï¼š\n1. è¿›å…¥"è®¾ç½®" â†’ "æœåŠ¡å•†"\n2. æ·»åŠ å¹¶é…ç½®è‡³å°‘ä¸€ä¸ª LLM æœåŠ¡å•†ï¼ˆå¦‚ OpenAIã€Claude ç­‰ï¼‰\n3. ç„¶åå›åˆ°è¿™é‡Œåˆ·æ–°æ¨¡å‹åˆ—è¡¨');
                    return;
                }

                selectEl.innerHTML = '';
                availableModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.id;
                    option.textContent = `${model.id} (${model.owned_by || 'unknown'})`;
                    if (model.id === config.model) {
                        option.selected = true;
                    }
                    selectEl.appendChild(option);
                });

                // å¦‚æœå½“å‰æ²¡æœ‰ä¿å­˜çš„æ¨¡å‹ï¼Œæˆ–ä¿å­˜çš„æ¨¡å‹ä¸åœ¨åˆ—è¡¨ä¸­ï¼Œè‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªï¼ˆé€šå¸¸æ˜¯ç½®é¡¶çš„æ¨¡å‹ï¼‰
                if (!config.model || !availableModels.find(m => m.id === config.model)) {
                    config.model = availableModels[0].id;
                    selectEl.value = config.model;
                    console.log('ğŸ¯ è‡ªåŠ¨é€‰æ‹©æ¨¡å‹:', config.model);
                }

            } catch (error) {
                selectEl.innerHTML = '<option value="">âŒ åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ API è®¾ç½®</option>';
                console.error('è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // æµ‹è¯•è¿æ¥
        async function testConnection() {
            // è¯»å–è¾“å…¥æ¡†çš„å½“å‰å€¼,è€Œä¸æ˜¯å·²ä¿å­˜çš„ config
            const apiUrl = document.getElementById('apiUrl').value.trim();

            if (!apiUrl) {
                alert('âŒ è¯·å…ˆå¡«å†™ API åœ°å€');
                return;
            }

            try {
                const response = await fetch(`${apiUrl}/v1/models`, {
                    headers: {
                        'Authorization': `Bearer ${INTERNAL_API_KEY}`
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const count = data.data ? data.data.length : 0;
                    if (count > 0) {
                        alert(`âœ… è¿æ¥æˆåŠŸï¼\n\næ‰¾åˆ° ${count} ä¸ªå¯ç”¨æ¨¡å‹`);
                    } else {
                        alert('âš ï¸ è¿æ¥æˆåŠŸï¼Œä½†æœªæ‰¾åˆ°æ¨¡å‹\n\nè¯·åœ¨ Knowledge åº”ç”¨ä¸­é…ç½® LLM æœåŠ¡å•†');
                    }
                } else {
                    alert(`âŒ è¿æ¥å¤±è´¥\n\nHTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                alert(`âŒ è¿æ¥å¤±è´¥\n\n${error.message}\n\nè¯·æ£€æŸ¥ï¼š\n1. API åœ°å€æ˜¯å¦æ­£ç¡®\n2. Knowledge åº”ç”¨æ˜¯å¦è¿è¡Œ\n3. API Server æ˜¯å¦å·²å¯ç”¨`);
            }
        }

        // ä¿å­˜è®¾ç½®
        function saveSettings() {
            config.apiUrl = document.getElementById('apiUrl').value;
            config.assistantId = document.getElementById('assistantId').value.trim();
            const selectedModel = document.getElementById('modelSelect').value;
            if (selectedModel) {
                config.model = selectedModel;
            }

            localStorage.setItem('apiUrl', config.apiUrl);
            localStorage.setItem('model', config.model);
            localStorage.setItem('assistantId', config.assistantId);
            localStorage.setItem('knowledgeBases', JSON.stringify(config.knowledgeBases || []));

            toggleSettings();
            updateStatus();
            
            let alertMsg = 'âœ… è®¾ç½®å·²ä¿å­˜ï¼\n\nå½“å‰æ¨¡å‹: ' + config.model;
            if (config.assistantId) {
                alertMsg += '\nåŠ©æ‰‹ID: ' + config.assistantId;
                alertMsg += '\nçŸ¥è¯†åº“æ•°é‡: ' + (config.knowledgeBases?.length || 0);
                if (config.knowledgeBases && config.knowledgeBases.length > 0) {
                    alertMsg += '\n\nğŸ’¡ å°†è‡ªåŠ¨ä½¿ç”¨åŠ©æ‰‹å…³è”çš„çŸ¥è¯†åº“';
                } else {
                    alertMsg += '\n\nâš ï¸ æç¤º: è¯·ä½¿ç”¨"å¯¼å…¥åŠ©æ‰‹é…ç½®"åŠŸèƒ½å¯¼å…¥çŸ¥è¯†åº“é…ç½®';
                }
            } else {
                alertMsg += '\n\nğŸ’¡ æç¤º: ä½¿ç”¨"å¯¼å…¥åŠ©æ‰‹é…ç½®"å¯å¯ç”¨çŸ¥è¯†åº“åŠŸèƒ½';
            }
            alert(alertMsg);
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€
        async function updateStatus() {
            const statusEl = document.getElementById('status');
            try {
                const response = await fetch(`${config.apiUrl}/v1/models`, {
                    headers: {
                        'Authorization': `Bearer ${INTERNAL_API_KEY}`
                    }
                });
                if (response.ok) {
                    const data = await response.json();
                    const count = data.data ? data.data.length : 0;
                    statusEl.textContent = count > 0 ? `âœ… å·²è¿æ¥ (${count} æ¨¡å‹)` : 'âš ï¸ å·²è¿æ¥ (æ— æ¨¡å‹)';
                    statusEl.className = count > 0 ? 'text-sm text-green-600' : 'text-sm text-yellow-600';
                } else {
                    statusEl.textContent = 'âŒ è¿æ¥å¤±è´¥';
                    statusEl.className = 'text-sm text-red-600';
                }
            } catch (error) {
                statusEl.textContent = 'âŒ æ— æ³•è¿æ¥';
                statusEl.className = 'text-sm text-red-600';
            }
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢
        function addMessage(content, isUser = false, citations = null) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = isUser ? 'text-right' : '';

            const bubble = document.createElement('div');
            bubble.className = `p-4 rounded-lg ${isUser
                    ? 'inline-block bg-blue-500 text-white max-w-xl ml-auto'
                    : 'bg-white shadow-sm text-gray-800'
                }`;
            
            // ç”¨æˆ·æ¶ˆæ¯ä½¿ç”¨çº¯æ–‡æœ¬,AI æ¶ˆæ¯ä½¿ç”¨ Markdown æ¸²æŸ“
            if (isUser) {
                bubble.textContent = content;
            } else {
                bubble.className += ' markdown-content';
                // é…ç½® marked é€‰é¡¹
                marked.setOptions({
                    breaks: true, // æ”¯æŒæ¢è¡Œ
                    gfm: true, // GitHub Flavored Markdown
                    highlight: function(code, lang) {
                        if (lang && hljs.getLanguage(lang)) {
                            try {
                                return hljs.highlight(code, { language: lang }).value;
                            } catch (err) {}
                        }
                        return hljs.highlightAuto(code).value;
                    }
                });
                bubble.innerHTML = marked.parse(content);
                // æ¸²æŸ“æ•°å­¦å…¬å¼å’Œå¼•ç”¨
                renderMathAndCitations(bubble);
            }

            messageDiv.appendChild(bubble);
            
            // å¦‚æœæœ‰å¼•ç”¨æ•°æ®,å…ˆè¿‡æ»¤ç›¸ä¼¼åº¦ä½äº 50% çš„å¼•ç”¨,ç„¶åå°†å¼•ç”¨åˆ—è¡¨ä½œä¸ºç‹¬ç«‹å…ƒç´ æ·»åŠ (AIæ¶ˆæ¯æ‰æœ‰å¼•ç”¨)
            if (!isUser && citations && citations.length > 0) {
                // è¿‡æ»¤ç›¸ä¼¼åº¦ä½äº 50% çš„å¼•ç”¨
                const filteredCitations = citations.filter(c => {
                    if (c.score === undefined) return true;
                    return c.score >= 0.5;
                });
                
                if (filteredCitations.length > 0) {
                    const citationsList = createCitationsList(filteredCitations);
                    citationsList.style.marginTop = '8px'; // ä¸æ¶ˆæ¯æ°”æ³¡ä¿æŒé—´è·
                    messageDiv.appendChild(citationsList);
                }
            }
            
            messagesDiv.appendChild(messageDiv);

            // æ»šåŠ¨åˆ°åº•éƒ¨
            document.getElementById('chatContainer').scrollTop =
                document.getElementById('chatContainer').scrollHeight;
        }

        // æ¸…é™¤æ‰€æœ‰èŠå¤©è®°å½•
        function clearAllMessages() {
            if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿ\næ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                return;
            }
            
            const messagesDiv = document.getElementById('messages');
            // æ¸…ç©ºæ‰€æœ‰æ¶ˆæ¯
            messagesDiv.innerHTML = '';
            
            // é‡æ–°æ·»åŠ æ¬¢è¿æ¶ˆæ¯
            const welcomeDiv = document.createElement('div');
            welcomeDiv.className = 'bg-white p-4 rounded-lg shadow-sm';
            welcomeDiv.innerHTML = `
                <div class="markdown-content text-gray-600">
                    <p>ğŸ‘‹ <strong>æ‚¨å¥½!</strong> æˆ‘æ˜¯ Knowledge AI åŠ©æ‰‹ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®æ‚¨çš„å—ï¼Ÿ</p>
                </div>
            `;
            messagesDiv.appendChild(welcomeDiv);
            
            // æç¤ºç”¨æˆ·
            const notification = document.createElement('div');
            notification.className = 'bg-green-50 border border-green-200 p-3 rounded-lg text-sm text-green-800';
            notification.innerHTML = 'âœ… èŠå¤©è®°å½•å·²æ¸…é™¤ï¼Œå¯ä»¥å¼€å§‹æ–°çš„å¯¹è¯äº†';
            messagesDiv.appendChild(notification);
            
            // 3ç§’åç§»é™¤æç¤º
            setTimeout(() => {
                notification.remove();
            }, 3000);
            
            console.log('ğŸ—‘ï¸ èŠå¤©è®°å½•å·²æ¸…é™¤');
        }

        // å‘é€æ¶ˆæ¯ (æµå¼å“åº”ç‰ˆæœ¬)
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            const message = input.value.trim();

            if (!message) return;

            // æ£€æŸ¥æ˜¯å¦æœ‰å¯ç”¨æ¨¡å‹
            if (!config.model || config.model === '') {
                alert('âš ï¸ è¯·å…ˆé…ç½®æ¨¡å‹\n\nç‚¹å‡»å³ä¸Šè§’ âš™ï¸ è®¾ç½®ï¼Œé€‰æ‹©ä¸€ä¸ªå¯ç”¨çš„æ¨¡å‹');
                toggleSettings();
                return;
            }

            // ç¦ç”¨è¾“å…¥
            input.disabled = true;
            sendBtn.disabled = true;

            // æ˜¾ç¤ºç”¨æˆ·æ¶ˆæ¯
            addMessage(message, true);
            input.value = '';

            // åˆ›å»º AI å›å¤å®¹å™¨
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = '';

            const bubble = document.createElement('div');
            bubble.className = 'p-4 rounded-lg bg-white shadow-sm text-gray-800 markdown-content';
            bubble.id = 'streaming-message';
            
            // æ ¹æ®æ˜¯å¦ä½¿ç”¨çŸ¥è¯†åº“æ˜¾ç¤ºä¸åŒçš„åŠ è½½æç¤º
            const hasKnowledgeBase = config.knowledgeBases && config.knowledgeBases.length > 0;
            bubble.innerHTML = hasKnowledgeBase 
                ? '<span class="text-blue-600">ğŸ” æ­£åœ¨æœç´¢çŸ¥è¯†åº“...</span>'
                : '<span class="text-gray-400">â³ æ­£åœ¨æ€è€ƒ...</span>';

            messageDiv.appendChild(bubble);
            messagesDiv.appendChild(messageDiv);

            // æ»šåŠ¨åˆ°åº•éƒ¨
            const scrollToBottom = () => {
                const container = document.getElementById('chatContainer');
                container.scrollTop = container.scrollHeight;
            };
            scrollToBottom();

            try {
                // æ„é€ è¯·æ±‚ä½“
                const requestBody = {
                    model: config.model,
                    messages: [
                        { role: 'user', content: message }
                    ],
                    stream: true  // å¯ç”¨æµå¼å“åº”
                };

                // å¦‚æœè®¾ç½®äº†åŠ©æ‰‹IDï¼Œæ·»åŠ åˆ°è¯·æ±‚ä¸­
                if (config.assistantId) {
                    requestBody.assistant_id = config.assistantId;
                }
                
                // å¦‚æœæœ‰çŸ¥è¯†åº“é…ç½®ï¼Œæ·»åŠ åˆ°è¯·æ±‚ä¸­
                if (config.knowledgeBases && config.knowledgeBases.length > 0) {
                    requestBody.knowledge_bases = config.knowledgeBases;
                }

                // è¯¦ç»†æ—¥å¿—
                console.group('ğŸ“¤ å‘é€æµå¼è¯·æ±‚');
                console.log('URL:', `${config.apiUrl}/v1/chat/completions`);
                console.log('Model:', config.model);
                console.log('Stream:', true);
                console.log('Assistant ID:', config.assistantId || 'âŒ æœªè®¾ç½®');
                console.log('Knowledge Bases:', config.knowledgeBases?.length || 0);
                console.groupEnd();

                // è®°å½•å¼€å§‹æ—¶é—´
                const startTime = Date.now();
                let firstTokenTime = null;
                let fullContent = '';
                let citations = []; // æ”¶é›†å¼•ç”¨æ•°æ®

                // è°ƒç”¨ API (æµå¼)
                const response = await fetch(`${config.apiUrl}/v1/chat/completions`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${INTERNAL_API_KEY}`
                    },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('âŒ API é”™è¯¯å“åº”:', errorText);
                    throw new Error(`API é”™è¯¯ ${response.status}: ${errorText}`);
                }

                // å¤„ç†æµå¼å“åº”
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                console.log('ğŸ“¥ å¼€å§‹æ¥æ”¶æµå¼æ•°æ®...');

                while (true) {
                    const { done, value } = await reader.read();
                    
                    if (done) {
                        console.log('âœ… æµå¼å“åº”å®Œæˆ');
                        break;
                    }

                    // è§£ç æ•°æ®å—
                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.trim() === '') continue;
                        if (line.trim() === 'data: [DONE]') continue;
                        
                        if (line.startsWith('data: ')) {
                            try {
                                const jsonStr = line.slice(6); // ç§»é™¤ "data: " å‰ç¼€
                                const data = JSON.parse(jsonStr);
                                
                                // æå–å†…å®¹
                                if (data.choices && data.choices[0]?.delta?.content) {
                                    const content = data.choices[0].delta.content;
                                    fullContent += content;
                                    
                                    // è®°å½•é¦–ä¸ª token æ—¶é—´
                                    if (!firstTokenTime) {
                                        firstTokenTime = Date.now();
                                        const timeToFirstToken = ((firstTokenTime - startTime) / 1000).toFixed(2);
                                        console.log(`âš¡ é¦–ä¸ª token æ—¶é—´: ${timeToFirstToken} ç§’`);
                                    }
                                    
                                    // å®æ—¶æ¸²æŸ“ Markdown
                                    bubble.innerHTML = marked.parse(fullContent);
                                    // æ¸²æŸ“æ•°å­¦å…¬å¼å’Œå¼•ç”¨
                                    renderMathAndCitations(bubble);
                                    scrollToBottom();
                                }
                                
                                // æå–å¼•ç”¨æ•°æ® (å¦‚æœæœ‰)
                                if (data.choices && data.choices[0]?.message?.citations) {
                                    // è¿‡æ»¤ç›¸ä¼¼åº¦ä½äº 50% çš„å¼•ç”¨
                                    const allCitations = data.choices[0].message.citations;
                                    citations = allCitations.filter(c => {
                                        // å¦‚æœæ²¡æœ‰ score å­—æ®µï¼Œä¿ç•™è¯¥å¼•ç”¨
                                        if (c.score === undefined) return true;
                                        // åªä¿ç•™ç›¸ä¼¼åº¦ >= 0.5 (50%) çš„å¼•ç”¨
                                        return c.score >= 0.5;
                                    });
                                    console.log(`ğŸ“š æ”¶åˆ°å¼•ç”¨æ•°æ®: ${allCitations.length} ä¸ªï¼Œè¿‡æ»¤å: ${citations.length} ä¸ª (>= 50%)`);
                                }
                            } catch (e) {
                                // å¿½ç•¥è§£æé”™è¯¯ï¼Œç»§ç»­å¤„ç†ä¸‹ä¸€è¡Œ
                            }
                        }
                    }
                }

                // è®¡ç®—æ€»æ—¶é—´
                const endTime = Date.now();
                const totalTime = ((endTime - startTime) / 1000).toFixed(2);
                const generationTime = firstTokenTime ? ((endTime - firstTokenTime) / 1000).toFixed(2) : '0';
                
                console.group('ğŸ“Š æ€§èƒ½ç»Ÿè®¡');
                console.log(`â±ï¸ æ€»æ—¶é—´: ${totalTime} ç§’`);
                console.log(`âš¡ é¦–ä¸ª token: ${((firstTokenTime - startTime) / 1000).toFixed(2)} ç§’`);
                console.log(`âœï¸ ç”Ÿæˆæ—¶é—´: ${generationTime} ç§’`);
                console.log(`ğŸ“ å†…å®¹é•¿åº¦: ${fullContent.length} å­—ç¬¦`);
                console.log(`ğŸ“š å¼•ç”¨æ•°é‡: ${citations.length}`);
                console.groupEnd();

                // ç§»é™¤ä¸´æ—¶ ID
                bubble.removeAttribute('id');

                // æ·»åŠ å¼•ç”¨åˆ—è¡¨(å¦‚æœæœ‰å¼•ç”¨æ•°æ®)
                if (citations && citations.length > 0) {
                    const citationsList = createCitationsList(citations);
                    citationsList.style.marginTop = '8px'; // ä¸æ¶ˆæ¯æ°”æ³¡ä¿æŒé—´è·
                    messageDiv.appendChild(citationsList);
                }

            } catch (error) {
                console.error('å‘é€æ¶ˆæ¯å¤±è´¥:', error);
                
                // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                const bubble = document.getElementById('streaming-message');
                if (bubble) {
                    let errorMsg = `âŒ é”™è¯¯: ${error.message}`;
                    if (error.message.includes('API é”™è¯¯')) {
                        errorMsg += '\n\nå¯èƒ½çš„åŸå› :\n1. æ¨¡å‹æœªé…ç½®æˆ–ä¸å¯ç”¨\n2. API Key é”™è¯¯\n3. ç½‘ç»œé—®é¢˜';
                    }
                    bubble.innerHTML = `<pre class="whitespace-pre-wrap">${errorMsg}</pre>`;
                    bubble.removeAttribute('id');
                }
            } finally {
                // æ¢å¤è¾“å…¥
                input.disabled = false;
                sendBtn.disabled = false;
                input.focus();
            }
        }

        // åˆ›å»ºå¼•ç”¨åˆ—è¡¨
        function createCitationsList(citations) {
            const container = document.createElement('div');
            container.className = 'citations-list';
            
            const title = document.createElement('div');
            title.className = 'citations-list-title';
            title.innerHTML = `
                <span>ğŸ“š</span>
                <span>å¼•ç”¨æ¥æº (${citations.length})</span>
            `;
            container.appendChild(title);
            
            // åˆ›å»ºç½‘æ ¼å®¹å™¨
            const grid = document.createElement('div');
            grid.style.cssText = `
                display: grid;
                grid-template-columns: repeat(auto-fill, minmax(380px, 1fr));
                gap: 12px;
            `;
            
            citations.forEach((citation, index) => {
                const item = document.createElement('div');
                item.className = 'citation-item';
                item.onclick = () => showCitationDetailTooltip(citation, index + 1);
                
                const number = document.createElement('div');
                number.className = 'citation-item-number';
                number.textContent = index + 1;
                
                const content = document.createElement('div');
                content.className = 'citation-item-content';
                
                const itemTitle = document.createElement('div');
                itemTitle.className = 'citation-item-title';
                itemTitle.textContent = citation.title || citation.url || `å¼•ç”¨ ${index + 1}`;
                
                const preview = document.createElement('div');
                preview.className = 'citation-item-preview';
                preview.textContent = citation.content || 'ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ…...';
                
                const meta = document.createElement('div');
                meta.className = 'citation-item-meta';
                
                // æ·»åŠ å…ƒæ•°æ®
                if (citation.type) {
                    const typeSpan = document.createElement('span');
                    typeSpan.textContent = citation.type === 'knowledge' ? 'ğŸ“„ çŸ¥è¯†åº“' : 
                                          citation.type === 'websearch' ? 'ğŸ” ç½‘ç»œæœç´¢' : 'ğŸ’¾ è®°å¿†';
                    meta.appendChild(typeSpan);
                }
                
                if (citation.score !== undefined) {
                    const scoreSpan = document.createElement('span');
                    scoreSpan.textContent = `ç›¸ä¼¼åº¦: ${(citation.score * 100).toFixed(1)}%`;
                    meta.appendChild(scoreSpan);
                }
                
                content.appendChild(itemTitle);
                content.appendChild(preview);
                if (meta.children.length > 0) {
                    content.appendChild(meta);
                }
                
                item.appendChild(number);
                item.appendChild(content);
                grid.appendChild(item);
            });
            
            container.appendChild(grid);
            return container;
        }

        // æ˜¾ç¤ºå¼•ç”¨è¯¦ç»†ä¿¡æ¯å¼¹çª—
        function showCitationDetailTooltip(citation, number) {
            // ç§»é™¤å·²å­˜åœ¨çš„å¼¹çª—
            if (currentTooltip) {
                currentTooltip.remove();
            }

            const tooltip = document.createElement('div');
            tooltip.className = 'citation-tooltip show';
            
            tooltip.innerHTML = `
                <div class="citation-tooltip-header">
                    <span class="citation-tooltip-icon">${citation.type === 'knowledge' ? 'ğŸ“„' : 'ğŸ”'}</span>
                    <div class="citation-title">${citation.title || `å¼•ç”¨ ${number}`}</div>
                    <span class="citation-badge">å¼•ç”¨ ${number}</span>
                </div>
                <div class="citation-content">
                    ${citation.content || 'æ— å†…å®¹é¢„è§ˆ'}
                </div>
                <div class="citation-url">
                    <span>${citation.type === 'knowledge' ? 'ğŸ“‘' : 'ğŸŒ'}</span>
                    <span>${citation.url || citation.title || 'æ¥æº: çŸ¥è¯†åº“'}</span>
                </div>
            `;
            
            // å±…ä¸­æ˜¾ç¤º
            tooltip.style.left = '50%';
            tooltip.style.top = '50%';
            tooltip.style.transform = 'translate(-50%, -50%)';
            
            // ç‚¹å‡»å¼¹çª—å¤–å…³é—­
            setTimeout(() => {
                document.addEventListener('click', function closeTooltip(e) {
                    if (!tooltip.contains(e.target)) {
                        tooltip.remove();
                        currentTooltip = null;
                        document.removeEventListener('click', closeTooltip);
                    }
                });
            }, 10);
            
            document.body.appendChild(tooltip);
            currentTooltip = tooltip;
        }

        // æ¸²æŸ“æ•°å­¦å…¬å¼å’Œå¼•ç”¨æ ‡æ³¨
        function renderMathAndCitations(element) {
            // 1. æ¸²æŸ“ KaTeX æ•°å­¦å…¬å¼
            if (window.renderMathInElement) {
                try {
                    renderMathInElement(element, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true},
                            {left: '$', right: '$', display: false},
                            {left: '\\[', right: '\\]', display: true},
                            {left: '\\(', right: '\\)', display: false}
                        ],
                        throwOnError: false,
                        errorColor: '#cc0000',
                        strict: false
                    });
                } catch (e) {
                    console.warn('KaTeX æ¸²æŸ“å¤±è´¥:', e);
                }
            }

            // 2. å¤„ç†å¼•ç”¨æ ‡æ³¨ [cite:N] æˆ– [N]
            processCitations(element);
        }

        // å¤„ç†å¼•ç”¨æ ‡æ³¨
        function processCitations(element) {
            // æŸ¥æ‰¾æ‰€æœ‰å¼•ç”¨æ ‡è®°: [cite:1], [1], [2] ç­‰
            const citationRegex = /\[(?:cite:)?(\d+)\]/g;
            
            // éå†æ‰€æœ‰æ–‡æœ¬èŠ‚ç‚¹
            const walker = document.createTreeWalker(
                element,
                NodeFilter.SHOW_TEXT,
                {
                    acceptNode: function(node) {
                        // è·³è¿‡ code å’Œ pre æ ‡ç­¾å†…çš„æ–‡æœ¬
                        if (node.parentElement.tagName === 'CODE' || 
                            node.parentElement.tagName === 'PRE') {
                            return NodeFilter.FILTER_REJECT;
                        }
                        return citationRegex.test(node.textContent) ? 
                            NodeFilter.FILTER_ACCEPT : NodeFilter.FILTER_REJECT;
                    }
                }
            );

            const textNodes = [];
            while (walker.nextNode()) {
                textNodes.push(walker.currentNode);
            }

            // æ›¿æ¢æ–‡æœ¬èŠ‚ç‚¹ä¸­çš„å¼•ç”¨æ ‡è®°
            textNodes.forEach(node => {
                const parent = node.parentElement;
                const text = node.textContent;
                const fragment = document.createDocumentFragment();
                
                let lastIndex = 0;
                let match;
                citationRegex.lastIndex = 0; // é‡ç½®æ­£åˆ™
                
                while ((match = citationRegex.exec(text)) !== null) {
                    const citationNum = match[1];
                    
                    // æ·»åŠ å¼•ç”¨å‰çš„æ–‡æœ¬
                    if (match.index > lastIndex) {
                        fragment.appendChild(
                            document.createTextNode(text.slice(lastIndex, match.index))
                        );
                    }
                    
                    // åˆ›å»ºå¼•ç”¨æ ‡ç­¾
                    const citation = document.createElement('span');
                    citation.className = 'citation';
                    citation.textContent = citationNum;
                    citation.dataset.citationId = citationNum;
                    citation.title = `ç‚¹å‡»æŸ¥çœ‹å¼•ç”¨ #${citationNum}`;
                    
                    // æ·»åŠ ç‚¹å‡»äº‹ä»¶
                    citation.addEventListener('click', function(e) {
                        showCitationTooltip(e, citationNum);
                    });
                    
                    fragment.appendChild(citation);
                    lastIndex = match.index + match[0].length;
                }
                
                // æ·»åŠ å‰©ä½™æ–‡æœ¬
                if (lastIndex < text.length) {
                    fragment.appendChild(document.createTextNode(text.slice(lastIndex)));
                }
                
                // æ›¿æ¢åŸæ–‡æœ¬èŠ‚ç‚¹
                if (fragment.childNodes.length > 0) {
                    parent.replaceChild(fragment, node);
                }
            });
        }

        // æ˜¾ç¤ºå¼•ç”¨å¼¹çª—
        let currentTooltip = null;
        function showCitationTooltip(event, citationId) {
            // ç§»é™¤å·²å­˜åœ¨çš„å¼¹çª—
            if (currentTooltip) {
                currentTooltip.remove();
            }

            // åˆ›å»ºå¼¹çª—
            const tooltip = document.createElement('div');
            tooltip.className = 'citation-tooltip show';
            
            // è¿™é‡Œå¯ä»¥ä» API å“åº”ä¸­è·å–çœŸå®çš„å¼•ç”¨ä¿¡æ¯
            // ç›®å‰æ˜¾ç¤ºå ä½ä¿¡æ¯
            tooltip.innerHTML = `
                <div class="citation-tooltip-header">
                    <span class="citation-tooltip-icon">ğŸ“„</span>
                    <div class="citation-title">çŸ¥è¯†åº“å¼•ç”¨ #${citationId}</div>
                    <span class="citation-badge">å¼•ç”¨ ${citationId}</span>
                </div>
                <div class="citation-content">
                    <p><strong>æ­£åœ¨åŠ è½½å¼•ç”¨å†…å®¹...</strong></p>
                    <p style="margin-top: 8px; color: #9ca3af; font-size: 0.9em;">
                        ğŸ’¡ <em>å®é™…å¼•ç”¨ä¿¡æ¯å°†ä»çŸ¥è¯†åº“æ£€ç´¢ç»“æœä¸­æå–</em>
                    </p>
                    <p style="margin-top: 8px; color: #6b7280;">
                        è¯¥å¼•ç”¨æ¥è‡ªçŸ¥è¯†åº“æ–‡æ¡£,åŒ…å«ç›¸å…³æ®µè½å†…å®¹å’Œä¸Šä¸‹æ–‡ä¿¡æ¯ã€‚
                        å½“ API è¿”å› citations æ•°æ®æ—¶,è¿™é‡Œå°†æ˜¾ç¤ºå…·ä½“çš„å¼•ç”¨ç‰‡æ®µã€‚
                    </p>
                </div>
                <div class="citation-url">
                    <span>ğŸ“‘</span>
                    <span>æ¥æº: çŸ¥è¯†åº“æ–‡æ¡£</span>
                </div>
            `;
            
            // å®šä½å¼¹çª—
            const rect = event.target.getBoundingClientRect();
            const tooltipWidth = 400; // é¢„ä¼°å®½åº¦
            
            // è®¡ç®—æ°´å¹³ä½ç½® (ä¼˜å…ˆå³ä¾§,ä¸å¤Ÿåˆ™å·¦ä¾§)
            let left = rect.left;
            if (left + tooltipWidth > window.innerWidth) {
                left = Math.max(10, window.innerWidth - tooltipWidth - 10);
            }
            
            // è®¡ç®—å‚ç›´ä½ç½® (ä¼˜å…ˆä¸‹æ–¹,ä¸å¤Ÿåˆ™ä¸Šæ–¹)
            let top = rect.bottom + 8;
            if (top + 300 > window.innerHeight) {
                top = rect.top - 8;
                tooltip.style.transform = 'translateY(-100%)';
            }
            
            tooltip.style.left = `${left}px`;
            tooltip.style.top = `${top}px`;
            
            // ç‚¹å‡»å¼¹çª—å¤–å…³é—­
            setTimeout(() => {
                document.addEventListener('click', function closeTooltip(e) {
                    if (!tooltip.contains(e.target)) {
                        tooltip.remove();
                        currentTooltip = null;
                        document.removeEventListener('click', closeTooltip);
                    }
                });
            }, 10);
            
            document.body.appendChild(tooltip);
            currentTooltip = tooltip;

            // é˜²æ­¢ç«‹å³è§¦å‘å…³é—­
            event.stopPropagation();
        }

        // å®šæœŸæ£€æŸ¥è¿æ¥çŠ¶æ€
        setInterval(updateStatus, 30000);
    </script>
</body>

</html>