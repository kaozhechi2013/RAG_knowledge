# Knowledge 项目技术架构说明

## 🏗️ 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                     本地服务器                               │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Knowledge 桌面应用 (Electron)                        │  │
│  │  ┌────────────────┐  ┌────────────────────────────┐  │  │
│  │  │  前端界面       │  │  内置 API Server           │  │  │
│  │  │  (React)       │  │  (Express.js:8080)         │  │  │
│  │  │                │  │                            │  │  │
│  │  │  - 聊天对话    │◄─┤  - 统一管理多个AI服务     │  │  │
│  │  │  - 模型配置    │  │  - 提供标准API接口         │  │  │
│  │  │  - 知识库管理  │  │  - 支持并发处理           │  │  │
│  │  └────────────────┘  └────────────────────────────┘  │  │
│  └──────────────────────────────────────────────────────┘  │
│                              │                              │
│  ┌──────────────────────────┼──────────────────────────┐  │
│  │  Ollama (本地AI)          │  embedjs (知识库)        │  │
│  │  localhost:11434          │  RAG向量搜索             │  │
│  └──────────────────────────────────────────────────────┘  │
└──────────────────────────┬───────────────────────────────────┘
                           │
                           ├─→ 云端AI (SiliconFlow/OpenAI/DeepSeek)
                           │
                           └─→ 员工浏览器 (Web客户端:8081)
```

---

## 📦 核心组件

### 1. Knowledge 桌面应用 (Electron)

**定位**: 管理员使用的桌面软件

**技术架构**:
- **Electron**: Node.js(后端能力) + Chromium(界面显示)
- **运行环境**: Node.js v22+
- **部署方式**: Windows .exe 独立程序

**核心功能**:
- 图形化操作界面 (React)
- 聊天对话管理
- 模型配置与切换
- 知识库创建与管理
- API Server 控制面板

**内置 API Server (Express.js)**:
- **端口**: localhost:8080
- **作用**: 统一多个AI服务的访问接口
- **特性**: OpenAI兼容API、并发支持、权限管理
- **控制**: 通过界面"启动/停止"按钮管理

---

### 2. API Server (中转网关)

**工作流程**:
```
员工请求 → API Server → 解析模型 → 路由转发 → 
AI服务 → 返回结果 → 转发给员工
```

**核心价值**:
- 统一接口标准
- API Key权限验证
- 自动模型路由
- 使用日志监控
- 异步并发处理

---

### 3. Ollama (本地AI引擎)

**基本信息**:
- **端口**: localhost:11434
- **类型**: 独立程序,需单独安装
- **下载**: https://ollama.com
- **API**: OpenAI 兼容接口

**特点**:
- ✅ 本地运行,数据隐私
- ✅ 免费使用,无Token限制
- ❌ 串行处理,多用户排队
- ❌ 依赖本地GPU性能

---

### 4. embedjs (知识库框架)

**定位**: RAG(检索增强生成)系统

**工作原理**:
```
传统对话: 用户提问 → AI回答

知识库对话: 用户提问 → 搜索知识库 → 找到相关文档 → 
           增强提问 → AI基于知识库回答
```

**核心组件**:
- 向量嵌入: 文本转数字向量
- 向量数据库: LibSqlDb存储
- 文档加载器: PDF/Word/Markdown
- RAG引擎: 检索协调

**即插即用**:
- 配置知识库 → 自动启用
- 未配置 → 跳过流程
- 性能影响: +50-200ms

**并发能力**:
- 搜索: 30+并发
- 添加文档: 限制30任务

---

### 5. Web 客户端

**定位**: 员工使用的网页界面

**技术**: HTML + CSS + JavaScript

**部署**:
```
开发: python -m http.server 8081
生产: IIS/Nginx/Apache
```

**访问流程**:
```
浏览器 → http://IP:8081 → 打开网页 → 
输入问题 → 请求API(8080) → 获得回答
```

**知识库支持**:
- ✅ **已实现**：后端统一智能调度
- **工作机制**：
  1. Web端配置助手关联的知识库ID
  2. API Server智能中间件自动检测问题
  3. 需要时自动搜索知识库并增强提问
  4. 调用AI获得基于知识库的回答
- **并发支持**：
  - 知识库搜索：支持30+并发请求
  - 搜索耗时：50-200ms
  - 多用户共享，互不干扰

---

## 🔄 完整请求流程

### 场景1: 普通聊天 - 员工询问"今天天气怎么样"

```
1. 员工操作
   浏览器访问 → 选择模型 → 输入问题 → 发送

2. Web客户端
   构造请求 → POST到API Server(8080)
   body: { model: "gpt-4", messages: [{ role: "user", content: "今天天气怎么样" }] }

3. API Server
   验证Key → 解析模型 → 转发到云端AI

4. AI服务
   加载模型 → 推理计算 → 返回结果

5. 返回路径
   AI → API Server → Web → 显示答案
```

### 场景2: 知识库查询 - 员工询问"公司报销政策是什么"

```
1. 员工操作
   浏览器访问 → 选择模型 → 输入问题 → 发送
   
2. Web客户端
   构造请求 → POST到API Server(8080)
   body: { 
     model: "gpt-4", 
     messages: [{ role: "user", content: "公司报销政策是什么" }],
     assistant_id: "助手ID"  // 包含知识库配置
   }

3. API Server - 智能中间件处理
   ✓ 验证API Key
   ✓ 解析模型和助手配置
   ✓ 检测到助手关联了知识库
   
   🧠 意图分析 (智能检测)
   ├─ 使用AI分析问题
   ├─ 判断："公司报销政策" → 需要查询知识库
   └─ 提取搜索关键词: ["报销政策", "公司规定"]
   
   📚 知识库搜索 (并发处理)
   ├─ 搜索知识库: "报销政策"
   ├─ 向量相似度匹配
   ├─ 找到相关文档片段 (50-200ms)
   └─ 重排序(Rerank): 选出最相关的3-5条
   
   ✍️ 上下文增强
   原始问题: "公司报销政策是什么"
   增强后:
   """
   参考以下知识库内容回答问题:
   
   [知识库片段1]
   报销政策：员工因公产生的费用，需在30天内提交...
   
   [知识库片段2]
   报销范围包括：差旅费、餐饮费、交通费...
   
   用户问题: 公司报销政策是什么
   """

4. AI服务
   接收增强后的提问 → 推理计算 → 基于知识库内容回答

5. 返回路径
   AI回答 → API Server → Web → 显示带知识库来源的答案
```

---

## 🎛️ 知识库智能调度详解

### 中间件架构

```
用户请求
    ↓
┌─────────────────────────────────────────┐
│  API Server (Express.js)                │
│                                         │
│  ┌───────────────────────────────────┐ │
│  │  请求预处理中间件                  │ │
│  │  - API Key验证                    │ │
│  │  - 参数解析                       │ │
│  └───────────────────────────────────┘ │
│                ↓                        │
│  ┌───────────────────────────────────┐ │
│  │  🧠 搜索编排插件 (核心)           │ │
│  │  searchOrchestrationPlugin        │ │
│  │                                   │ │
│  │  Step 1: 意图识别                │ │
│  │  ├─ 检测助手是否配置知识库        │ │
│  │  ├─ AI分析问题意图                │ │
│  │  └─ 判断是否需要查询              │ │
│  │                                   │ │
│  │  Step 2: 知识库搜索 (如需要)     │ │
│  │  ├─ embedjs RAG框架              │ │
│  │  ├─ 向量搜索 (并发安全)          │ │
│  │  ├─ Rerank重排序                 │ │
│  │  └─ 返回Top-N结果                │ │
│  │                                   │ │
│  │  Step 3: 上下文增强              │ │
│  │  └─ 注入知识库内容到prompt       │ │
│  └───────────────────────────────────┘ │
│                ↓                        │
│  ┌───────────────────────────────────┐ │
│  │  AI服务路由                       │ │
│  │  - 转发到Ollama/云端AI            │ │
│  └───────────────────────────────────┘ │
└─────────────────────────────────────────┘
    ↓
AI返回结果
```

### 智能检测机制

**1. 自动判断**
```javascript
// API Server内部逻辑
if (assistant.knowledge_bases && assistant.knowledge_bases.length > 0) {
  // 使用AI分析用户问题
  const intent = await analyzeSearchIntent(userMessage, assistant)
  
  if (intent.needsKnowledgeSearch) {
    // 自动搜索知识库
    const knowledgeResults = await searchKnowledgeBases(
      intent.searchQuery,
      assistant.knowledge_bases
    )
    
    // 增强提问
    enhancedPrompt = buildPromptWithKnowledge(
      userMessage, 
      knowledgeResults
    )
  }
}
```

**2. 意图分析示例**

| 用户问题 | 是否需要知识库 | 搜索关键词 |
|---------|---------------|-----------|
| "今天天气怎么样" | ❌ 不需要 | - |
| "公司报销政策是什么" | ✅ 需要 | ["报销政策", "公司规定"] |
| "帮我写个Python排序代码" | ❌ 不需要 | - |
| "我们的产品有哪些功能" | ✅ 需要 | ["产品功能", "功能列表"] |

### 并发处理能力

**知识库服务 (KnowledgeService)**

```typescript
class KnowledgeService {
  // 并发控制
  private static MAXIMUM_WORKLOAD = 80 * MB
  private static MAXIMUM_PROCESSING_ITEM_COUNT = 30
  
  // 搜索是独立的，支持高并发
  async search(query: string, base: KnowledgeBase): Promise<Results[]> {
    // 向量搜索，无锁，支持多用户同时查询
    const results = await ragApplication.search(query)
    return results
  }
}
```

**并发特性**:

| 操作类型 | 并发能力 | 说明 |
|---------|---------|------|
| 📖 **搜索(Search)** | ✅ 30+并发 | 只读操作，无锁竞争 |
| ➕ **添加文档(Add)** | ⚠️ 队列处理 | 写入操作，限制30任务 |
| 🔄 **更新索引** | ⚠️ 串行 | 后台任务 |

**实际性能**:
```
场景: 10个员工同时询问不同问题，都需要查询知识库

传统方式 (串行):
用户1: 100ms
用户2: 200ms (等待)
用户3: 300ms (等待)
...
用户10: 1000ms

Knowledge系统 (并发):
所有用户: 100-200ms (同时处理)
```

### Web端配置示例

**方式1: 配置文件 (推荐用于生产)**
```javascript
// web-config.json
{
  "apiUrl": "http://192.168.1.100:8080",
  "apiKey": "sk-knowledge-2025",
  "defaultAssistant": {
    "id": "assistant_hr_001",
    "name": "HR助手",
    "knowledge_bases": ["kb_hr_policies_001"]
  }
}
```

**方式2: 界面配置 (开发中)**
```javascript
// 未来可在Web界面选择
<select id="assistantSelect">
  <option value="assistant_hr_001">HR助手 (含公司政策知识库)</option>
  <option value="assistant_tech_001">技术助手 (含技术文档知识库)</option>
</select>
```

---

## 🛠️ 技术栈

### 桌面应用

| 技术       | 用途                       |
| ---------- | -------------------------- |
| Electron   | Node.js + Chromium桌面框架 |
| Node.js    | 后端运行环境               |
| Chromium   | Chrome开源渲染引擎         |
| React      | 前端UI框架                 |
| TypeScript | 带类型的JavaScript         |
| Express.js | Web服务框架                |
| OpenAI SDK | AI服务统一客户端           |
| embedjs    | RAG知识库框架              |

### Web客户端

| 技术         | 用途         |
| ------------ | ------------ |
| HTML/CSS     | 页面结构样式 |
| JavaScript   | 交互逻辑     |
| Tailwind CSS | CSS框架      |
| Fetch API    | HTTP请求     |

### 外部服务

| 服务        | 类型   | 获取方式    |
| ----------- | ------ | ----------- |
| Ollama      | 本地AI | 下载安装    |
| SiliconFlow | 云端AI | 注册获取Key |
| OpenAI      | 云端AI | 注册获取Key |
| DeepSeek    | 云端AI | 注册获取Key |

---

## 🎯 核心概念

### Electron = Node.js + Chromium

```
Node.js(后端)        +  Chromium(前端)
系统级能力              界面显示能力
文件/网络/HTTP          HTML/CSS渲染
```

### OpenAI SDK 三大作用

1. **封装HTTP请求**: 无需手动写fetch
2. **统一接口**: 同样代码调用不同服务
3. **类型安全**: TypeScript定义和提示

**兼容服务**: OpenAI、Ollama、SiliconFlow、DeepSeek等

### embedjs 即插即用

**检测逻辑**:
```
有知识库配置 → 搜索 → 增强 → AI
无知识库配置 → 直接调用AI
```

**工作流程**:
```
上传: 文档 → 提取 → 分块 → 向量化 → 存储
查询: 问题 → 向量化 → 搜索 → 返回相关文档 → 增强prompt
```

---

## ⚡ 并发性能

### 系统组件并发能力

| 组件           | 并发特性 | 说明               |
| -------------- | -------- | ------------------ |
| **API Server** | 理论无限 | 异步非阻塞         |
| **云端AI**     | 真正并行 | 集群处理,1-3秒     |
| **Ollama**     | 串行排队 | 单GPU,3秒×队列长度 |
| **知识库**     | 30+并发  | 搜索50-200ms       |

### 实际场景(10用户)

**使用云端AI**:
```
所有用户: ~1-3秒响应
瓶颈: 无
```

**使用Ollama**:
```
用户1: 3秒
用户2: 6秒
用户10: 30秒
瓶颈: 本地GPU
```

### 推荐配置

| 用户数  | 方案   |
| ------- | ------ |
| 5-10人  | Ollama |
| 10-30人 | 混合   |
| 50+人   | 云端AI |

---

## 💡 常见问题

**Q: 为什么桌面应用需要Express.js?**

A: 三个原因:
- 对外提供HTTP API
- 统一管理多个AI服务
- 权限控制和路由

**Q: OpenAI SDK是什么?**

A: API客户端工具库:
- 封装HTTP请求
- 统一接口调用
- TypeScript类型支持

**Q: embedjs是即插即用吗?**

A: 是的:
- 配置 → 自动启用
- 不配置 → 跳过
- 影响: +50-200ms

**Q: Web端如何支持知识库?**

A: 自动智能调度:
- **无需额外操作**：配置助手关联知识库即可
- **智能检测**：AI分析问题是否需要查询知识库
- **自动搜索**：需要时自动从知识库检索相关文档
- **上下文增强**：将检索结果注入到AI提问中
- **并发安全**：30+用户同时使用无压力

**Q: 支持多少并发用户?**

A: 取决于AI服务:
- 云端: 100+用户
- Ollama: 10人内排队
- 知识库: 30+并发

**Q: Ollama必须安装吗?**

A: 不是必须:
- 只用云端 → 无需安装
- 用本地模型 → 必须安装

---

## 📋 快速部署

### 桌面应用
```
1. 安装Node.js v22+
2. yarn install
3. yarn dev (开发)
4. yarn build (打包)
```

### Ollama
```
1. 下载: ollama.com
2. 安装启动
3. ollama pull deepseek-r1:14b
4. 验证: localhost:11434
```

### Web客户端
```
开发: python -m http.server 8081
生产: IIS/Nginx/Apache托管
```

### API Server
```
1. 打开桌面应用
2. 设置 → API服务器
3. 点击"启动"
4. 记录API Key
5. 开放8080端口
```

---

## 🔧 维护建议

### 性能优化
- 定期清理知识库缓存
- 监控并发数
- 优化向量数据库

### 安全建议
- 定期更换API Key
- 防火墙限制IP
- 生产环境启用HTTPS

### 监控指标
- API响应时间
- GPU使用率
- 知识库搜索耗时
- Token消耗统计

---

*文档版本: v2.0*  
*最后更新: 2025年10月29日*
